var CIQ,$$$;CIQ.Account=function(){this.balances={},this.openOrders={},this.positions={},this.trades={}},CIQ.Account.prototype.fetchBalances=function(e){e()},CIQ.Account.prototype.fetchPositions=function(e){e()},CIQ.Account.prototype.fetchOpenOrders=function(e){e()},CIQ.Account.prototype.fetchTrades=function(e){e()},CIQ.Account.prototype.isForex=function(e){return CIQ.Market.Symbology.isForexSymbol(e)},CIQ.Account.prototype.tradesLikeForex=function(e){return CIQ.Market.Symbology.isForexSymbol(e)},CIQ.Account.prototype.placeOrder=function(e,t,i){},CIQ.Account.prototype.replaceOrder=function(e,t,i){},CIQ.Account.prototype.cancelOrder=function(e,t,i){},CIQ.Account.prototype.setProtection=function(e,t,i){},CIQ.Account.prototype.closeAllPositions=function(e,t){},CIQ.Account.prototype.closePosition=function(e,t,i){},CIQ.Account.prototype.closeTrade=function(e,t,i){},CIQ.Account.prototype.confirmOrder=function(e,t,i){i()},CIQ.Account.prototype.tradability=function(e,t){var i={tradable:!0,shortable:!0,marketable:!0,decimalPrecision:null};if(!e)return i.tradable=!1,void t(i);(function(e){return-1!=e.indexOf("$")||-1!=e.indexOf("^")&&7!=e.length})(e)&&(i.tradable=!1),0===e.indexOf("=")&&(i.tradable=!1),t(i)},CIQ.Account.prototype.disconnect=function(){this.Poller&&this.Poller.stopPolling()},CIQ.Account.prototype.Poller={intervals:{},startPolling:function(e){for(var t in this.intervals)clearInterval(this.intervals[t].timer),this.intervals[t].timer=setInterval((function(e,t,i){t.update(e,i)}),this.intervals[t].poll,e,this,t)},stopPolling:function(){for(var e in this.intervals)clearInterval(this.intervals[e].timer)},update:function(e,t){e.account&&("quotes"==t?this.updateQuotes(e):"account"==t&&this.updateAccount(e))},updateQuotes:function(e){if(e.stx.chart.symbol){var t=e.stx.currentQuote();t&&(t.Bid||(t.Bid=t.Close),t.Ask||(t.Ask=t.Close),e.updateValues())}},updateAccount:function(e){var t=e.stx.currentQuote();if(t){var i=e.account.positions[e.stx.chart.symbol];i&&(i.quantity>0?i.price=t.Bid||t.Close:i.price=t.Ask||t.Close);var s=e.account.trades[e.stx.chart.symbol];if(s)for(var n=0;n<s.length;n++)s[n].quantity>0?s[n].price=t.Bid||t.Close:s[n].price=t.Ask||t.Close;e.updateData(),s&&e.stx.draw()}}},CIQ.TFC=function(e){e.chart||(e.chart=e.stx.chart),this.modifyingOrder=null,this.positionScroller=null,this.openOrderScroller=null,this.construct(e),CIQ.I18N.translateUI()},CIQ.TFC.displayDialog=function(e){CIQ.hideKeyboard();for(var t=0;t<CIQ.ChartEngine.registeredContainers.length;t++)CIQ.ChartEngine.registeredContainers[t].stx.modalBegin();var i=$$$(e);i.style.display="block",CIQ.TFC.stack.push(i)},CIQ.TFC.dismissDialog=function(){document.activeElement.blur();var e=CIQ.TFC.stack.pop();if(e){if(e.style.display="none",!CIQ.TFC.stack.length)for(var t=0;t<CIQ.ChartEngine.registeredContainers.length;t++)CIQ.ChartEngine.registeredContainers[t].stx.modalEnd();CIQ.fixScreen()}},CIQ.TFC.stack=[],CIQ.TFC.prototype.dom={dragLineAbove:null,dragLineCenter:null,dragLineBelow:null,marketOrder:null,limitOrder:null,otoAbove:null,otoBelow:null,ocoOrder:null,ocoAbove:null,ocoBelow:null,shadeAbove:null,shadeBelow:null},CIQ.TFC.prototype.templates={openOrderMarker:null},CIQ.TFC.prototype.ephemeralNodes={openOrders:[]},CIQ.TFC.prototype.menu={enableMarket:{nodes:[],dom:["marketOrder"]},enableBuy:{nodes:[],dom:["limitOrder","dragLineCenter"]},enableSell:{nodes:[],dom:["limitOrder","dragLineCenter"]},enableShort:{nodes:[],dom:["limitOrder","dragLineCenter"]},enableCover:{nodes:[],dom:["limitOrder","dragLineCenter"]},enableStraddle:{nodes:[],dom:["ocoOrder","ocoAbove","ocoBelow","dragLineAbove","dragLineBelow","shadeAbove","shadeBelow"]},enableStrangle:{nodes:[],dom:["ocoOrder","ocoAbove","ocoBelow","dragLineAbove","dragLineBelow","shadeAbove","shadeBelow"]},enableBracket:{nodes:[],dom:["limitOrder","dragLineAbove","dragLineBelow","otoAbove","otoBelow","shadeAbove","shadeBelow"]}},CIQ.TFC.prototype.elements={},CIQ.TFC.prototype.isMobileMode=function(){return $(".break-sm").length>0},CIQ.TFC.prototype.dragOrdersHeader=function(e){var t=this.elements.openOrdersHeader;if(CIQ.hasClassName(t,"dragging")){isNaN(parseInt(this.initialPosition,10))&&(this.initialPosition=t.parentNode.offsetTop),t.resizedTop=t.parentNode.offsetTop;var i=this.initialPosition+e.displacementY;this.refreshScrollWindows(i)}},CIQ.TFC.prototype.positionAtPrice=function(e,t,i,s,n){i||(i="center");for(var r,o=this.locationFromPrice(e),a=0;a<t.length;a++){var l=t[a];r="string"==typeof l?this.dom[l]:l;var c,d,h=null;if("center"==i)h=o-r.offsetHeight/2;else if("top"==i){if(s)for(c=0;c<s.length;c++){d=this.dom[s[c]];var m=CIQ.stripPX(d.style.top)+d.offsetHeight;m>o&&(o=m)}h=Math.round(o)+1}else if("bottom"==i){if(s)for(c=0;c<s.length;c++)d=this.dom[s[c]],o>(h=CIQ.stripPX(d.style.top))&&(o=h);h=Math.round(o-r.offsetHeight)}r.removeAttribute("uncentered"),r.removeAttribute("off-screen"),n&&(h<0?(r.setAttribute("uncentered",!0),h<r.offsetHeight/2*-1&&r.setAttribute("off-screen",!0),h=0):h+r.offsetHeight>this.chart.panel.height&&(r.setAttribute("uncentered",!0),h+r.offsetHeight-this.chart.panel.height>r.offsetHeight/2&&r.setAttribute("off-screen",!0),h=this.chart.panel.height-r.offsetHeight)),null!==h&&(r.style.top=h+"px")}},CIQ.TFC.prototype.enableMarket=function(){this.activeTrade="market",this.account&&(this.dom.marketOrder.style.top="0px",this.account.isForex(this.stx.chart.symbol)?(this.elements.askForexPart.style.visibility="",this.elements.bidForexPart.style.visibility=""):(this.elements.askForexPart.style.visibility="hidden",this.elements.bidForexPart.style.visibility="hidden"),this.account.config.oto?this.elements.marketBracket.style.display="":this.elements.marketBracket.style.display="none",this.updateValues(),this.populateMarket())},CIQ.TFC.prototype.populateMarket=function(){this.elements.marketLossBracketDifferential.value="",this.elements.marketProfitBracketDifferential.value="",this.account.positions[this.chart.symbol]&&!1!==this.account.config.reducePosition?(this.setActiveInput("shares"),this.elements.marketShares.value=Math.abs(this.account.positions[this.chart.symbol].quantity),this.updateValues()):this.account.config.pts?(this.elements.marketShares.value=1,this.updateValues()):(this.setActiveInput(null),this.elements.marketShares.value=this.elements.marketCurrency.value="")},CIQ.TFC.prototype.snapPrice=function(e){var t=this.stx.chart.yAxis.minimumPriceTick;if(t||(t=1e-8),t){var i=1/t;e=Math.round(e*i)/i}return e},CIQ.TFC.prototype.getBidAsk=function(){var e=this.stx.currentQuote(),t=this.stx.currentMarketData,i=null,s=null;return t&&(t.Bid&&(i=t.Bid.Price),t.Ask&&(s=t.Ask.Price)),e&&(null===i&&(i=e.Bid||e.Close),null===s&&(s=e.Ask||e.Close)),{Bid:i,Ask:s}},CIQ.TFC.prototype.getCurrentPriceForOrder=function(e){var t=this.getBidAsk(),i=this.stx&&this.stx.currentQuote()?this.stx.currentQuote().Close:0;return e&&(i="sell"==e||"short"==e?t.Bid:t.Ask),this.snapPrice(i)},CIQ.TFC.prototype.initializeOrderPrice=function(e){if(this.centerPrice=this.getCurrentPriceForOrder(this.activeTrade),e&&e.openOrder){var t=this.centerPrice;e.openOrder.limit?t=e.openOrder.limit:e.openOrder.stop?t=e.openOrder.stop:e.openOrder.marketIfTouched&&(t=e.openOrder.marketIfTouched),this.centerPrice=t}},CIQ.TFC.prototype.enableBuy=function(e){if(stxx&&"heikinashi"===stxx.layout.aggregationType)return $.toast({text:"Trade from chart is not available for Heikin Ashi chart.",position:"top-center",stack:!1,hideAfter:4e3}),void this.closeTFC();let t=this.stx.chart.symbolObject.segment,i="eq";-1==t.indexOf("NFO")&&-1==t.indexOf("CDS")&&-1==t.indexOf("MCX")&&-1==t.indexOf("BFO")&&-1==t.indexOf("BCD")||(i="fo"),this.activeTrade="buy",CIQ.swapClassName(this.dom.dragLineAbove,"red","green"),CIQ.swapClassName(this.dom.dragLineBelow,"red","green"),CIQ.swapClassName(this.dom.dragLineCenter,"green","red"),CIQ.unappendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-short-order"),CIQ.appendClassName(this.dom.limitOrder,"new-buy-order"),CIQ.unappendClassName(this.dom.limitOrder,"with-stop"),CIQ.unappendClassName(this.dom.limitOrder,"with-limit"),this.initializeOrderPrice(e),this.positionAtPrice(this.centerPrice,["limitOrder","dragLineCenter"]),this.elements.dragLineCenterPrice.innerHTML=this.formatPrice(this.centerPrice),this.elements.dragLineCenterPrice.innerValue=this.formatInnerValue(this.centerPrice);let s=1;if(window.kiteAPI&&window.kiteAPI.instrumentManager&&(s=window.kiteAPI.instrumentManager.get(this.stx.chart.symbolObject.symbol.toUpperCase(),this.stx.chart.symbolObject.segment).lotSize,$("#tfc_qty_input").attr("min",s),$("#tfc_qty_input").attr("step",s)),this.account.config.pts&&(this.elements.limitShares.value=1),e&&e.openOrder){if(this.elements.limitShares.value=e.openOrder.quantity,this.elements.limitTIF.value=e.openOrder.tif,e.openOrder.oto)for(var n=0;n<e.openOrder.oto.length;n++)e.openOrder.oto[n].stop?this.addOTOStop(e.openOrder.oto[n].stop):e.openOrder.oto[n].limit&&this.addOTOLimit(e.openOrder.oto[n].limit);e.openOrder.oco?CIQ.appendClassName(this.dom.limitOrder,"oco"):CIQ.unappendClassName(this.dom.limitOrder,"oco"),this.elements.limitShares.disabled=!!e.openOrder.oco,this.elements.limitCurrency.disabled=!!e.openOrder.oco,this.elements.limitTIF.disabled=!!e.openOrder.oco,$(".su-switch-grp").hide(),$(".tfc-buy").hide(),$(".tfc-sell").hide(),$(".stx-select").prop("disabled","disabled"),$("#tfc_qty_input").attr("value",e.openOrder.quantity),$("#tfc_qty_input").val(e.openOrder.quantity)}else this.elements.limitShares.disabled=!1,this.elements.limitCurrency.disabled=!1,this.elements.limitTIF.disabled=!1,this.elements.limitShares.value=1,$(".su-switch-grp").show(),$(".tfc-buy").show(),$(".tfc-sell").hide(),$(".stx-select").prop("disabled",!1),$("#tfc_qty_input").attr("value",s),$("#tfc_qty_input").val(s);"eq"===i?(this.elements.cnc.style.display="block",this.elements.nrml.style.display="none",$(".stx-select")[0].value="CNC"):(this.elements.nrml.style.display="block",this.elements.cnc.style.display="none",$(".stx-select")[0].value="NRML"),e&&e.openOrder&&($(".stx-select")[0].value=e.openOrder.product),document.getElementsByClassName("tfc-error")[0].style.display="none",$("#buy-sell-switch").change((function(){this.checked?($(".tfc-buy").hide(),$(".tfc-sell").show()):($(".tfc-sell").hide(),$(".tfc-buy").show())})),$("#buy-sell-switch").prop("checked",!1)},CIQ.TFC.prototype.enableSell=function(e){if(stxx&&"heikinashi"===stxx.layout.aggregationType)return $.toast({text:"Trade from chart is not available for Heikin Ashi chart.",position:"top-center",stack:!1,hideAfter:4e3}),void this.closeTFC();let t=this.stx.chart.symbolObject.segment,i="eq";-1==t.indexOf("NFO")&&-1==t.indexOf("CDS")&&-1==t.indexOf("MCX")&&-1==t.indexOf("BFO")||(i="fo"),this.activeTrade="sell",CIQ.swapClassName(this.dom.dragLineCenter,"red","green"),CIQ.unappendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-buy-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-short-order"),CIQ.appendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.unappendClassName(this.dom.limitOrder,"with-stop"),CIQ.unappendClassName(this.dom.limitOrder,"with-limit");var s=0,n=this.account.positions[this.stx.chart.symbol];n&&(s=n.quantity),this.elements.sharesOwned.innerHTML=CIQ.commas(s),this.initializeOrderPrice(e),this.positionAtPrice(this.centerPrice,["limitOrder","dragLineCenter"]),this.elements.dragLineCenterPrice.innerHTML=this.formatPrice(this.centerPrice),this.elements.dragLineCenterPrice.innerValue=this.formatInnerValue(this.centerPrice),this.account.config.pts&&(this.elements.limitShares.value=1);let r=1;window.kiteAPI&&window.kiteAPI.instrumentManager&&(r=window.kiteAPI.instrumentManager.get(this.stx.chart.symbolObject.symbol.toUpperCase(),this.stx.chart.symbolObject.segment).lotSize,$("#tfc_qty_input").attr("min",r),$("#tfc_qty_input").attr("step",r)),e&&e.openOrder?(this.elements.limitShares.value=e.openOrder.quantity,this.elements.limitTIF.value=e.openOrder.tif,this.elements.limitShares.disabled=!!e.openOrder.oco,this.elements.limitCurrency.disabled=!!e.openOrder.oco,this.elements.limitTIF.disabled=!!e.openOrder.oco,$(".su-switch-grp").hide(),$(".tfc-buy").hide(),$(".tfc-sell").hide(),$(".stx-select").prop("disabled","disabled"),$("#tfc_qty_input").attr("value",e.openOrder.quantity),$("#tfc_qty_input").val(e.openOrder.quantity)):(this.elements.limitShares.disabled=!1,this.elements.limitCurrency.disabled=!1,this.elements.limitTIF.disabled=!1,$(".su-switch-grp").show(),$(".tfc-sell").show(),$(".stx-select").prop("disabled",!1),$("#tfc_qty_input").attr("value",r),$("#tfc_qty_input").val(r)),e&&e.openOrder&&($(".stx-select")[0].value=e.openOrder.product),$("#buy-sell-switch").change((function(){this.checked?($(".tfc-buy").hide(),$(".tfc-sell").show()):($(".tfc-sell").hide(),$(".tfc-buy").show())})),document.getElementsByClassName("tfc-error")[0].style.display="none",$("#tfc_qty_input").attr("value",e.openOrder.quantity),$("#tfc_qty_input").val(e.openOrder.quantity)},CIQ.TFC.prototype.enableShort=function(e){if(stxx&&"heikinashi"===stxx.layout.aggregationType)return $.toast({text:"Trade from chart is not available for Heikin Ashi chart.",position:"top-center",stack:!1,hideAfter:4e3}),void this.closeTFC();this.activeTrade="short",CIQ.swapClassName(this.dom.dragLineAbove,"green","red"),CIQ.swapClassName(this.dom.dragLineBelow,"green","red"),CIQ.swapClassName(this.dom.dragLineCenter,"red","green"),CIQ.unappendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-buy-order"),CIQ.appendClassName(this.dom.limitOrder,"new-short-order"),CIQ.unappendClassName(this.dom.limitOrder,"with-stop"),CIQ.unappendClassName(this.dom.limitOrder,"with-limit"),this.initializeOrderPrice(e),this.positionAtPrice(this.centerPrice,["limitOrder","dragLineCenter"]),this.elements.dragLineCenterPrice.innerHTML=this.formatPrice(this.centerPrice),this.elements.dragLineCenterPrice.innerValue=this.formatInnerValue(this.centerPrice),this.account.config.pts&&(this.elements.limitShares.value=1);let t=1;if(window.kiteAPI&&window.kiteAPI.instrumentManager&&(t=window.kiteAPI.instrumentManager.get(this.stx.chart.symbolObject.symbol.toUpperCase(),this.stx.chart.symbolObject.segment).lotSize,$("#tfc_qty_input").attr("min",t),$("#tfc_qty_input").attr("step",t)),e&&e.openOrder){if(this.elements.limitShares.value=e.openOrder.quantity,this.elements.limitTIF.value=e.openOrder.tif,e.openOrder.oto)for(var i=0;i<e.openOrder.oto.length;i++)e.openOrder.oto[i].stop?this.addOTOStop(e.openOrder.oto[i].stop):e.openOrder.oto[i].limit&&this.addOTOLimit(e.openOrder.oto[i].limit);e.openOrder.oco?CIQ.appendClassName(this.dom.limitOrder,"oco"):CIQ.unappendClassName(this.dom.limitOrder,"oco"),$(".su-switch-grp").hide(),$(".tfc-buy").hide(),$(".tfc-sell").hide(),$(".stx-select").prop("disabled","disabled"),$("#tfc_qty_input").attr("value",e.openOrder.quantity),$("#tfc_qty_input").val(e.openOrder.quantity)}else $(".su-switch-grp").show(),$(".tfc-sell").show(),$(".stx-select").prop("disabled",!1),$("#tfc_qty_input").attr("value",t),$("#tfc_qty_input").val(t);this.elements.limitShares.disabled=!1,this.elements.limitCurrency.disabled=!1,this.elements.limitTIF.disabled=!1,e&&e.openOrder&&$(".stx-select").val(e.openOrder.product),$("#buy-sell-switch").change((function(){this.checked?($(".tfc-buy").hide(),$(".tfc-sell").show()):($(".tfc-sell").hide(),$(".tfc-buy").show())})),document.getElementsByClassName("tfc-error")[0].style.display="none",$("#tfc_qty_input").attr("value",e.openOrder.quantity),$("#tfc_qty_input").val(e.openOrder.quantity)},CIQ.TFC.prototype.enableCover=function(e){this.activeTrade="cover",CIQ.swapClassName(this.dom.dragLineCenter,"green","red"),CIQ.unappendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-buy-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-short-order"),CIQ.appendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.unappendClassName(this.dom.limitOrder,"with-stop"),CIQ.unappendClassName(this.dom.limitOrder,"with-limit");var t=0,i=this.account.positions[this.stx.chart.symbol];i&&(t=i.quantity),this.elements.sharesOwned.innerHTML=CIQ.commas(t),this.initializeOrderPrice(e),this.positionAtPrice(this.centerPrice,["limitOrder","dragLineCenter"]),this.elements.dragLineCenterPrice.innerHTML=this.formatPrice(this.centerPrice),this.elements.dragLineCenterPrice.innerValue=this.formatInnerValue(this.centerPrice),this.account.config.pts&&(this.elements.limitShares.value=1),e&&e.openOrder&&(this.elements.limitShares.value=e.openOrder.quantity,this.elements.limitTIF.value=e.openOrder.tif),this.elements.limitShares.disabled=!1,this.elements.limitCurrency.disabled=!1,this.elements.limitTIF.disabled=!1},CIQ.TFC.prototype.enableBracket=function(e){this.isMobileMode();e&&e.trade?(this.elements.bracketId.value=e.trade.id,this.elements.limitCurrency.readOnly=!0,this.elements.limitShares.readOnly=!0,this.elements.limitShares.value=Math.abs(e.trade.quantity),CIQ.unappendClassName(this.elements.removeOTOAbove,"disable"),CIQ.unappendClassName(this.elements.removeOTOBelow,"disable")):(this.elements.bracketId.value="",this.elements.limitCurrency.readOnly=!1,this.elements.limitShares.readOnly=!1,CIQ.appendClassName(this.elements.removeOTOAbove,"disable"),CIQ.appendClassName(this.elements.removeOTOBelow,"disable")),CIQ.unappendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-short-order"),CIQ.unappendClassName(this.dom.limitOrder,"new-buy-order"),CIQ.unappendClassName(this.dom.shadeAbove,"tfc-profit"),CIQ.unappendClassName(this.dom.shadeBelow,"tfc-profit"),CIQ.swapClassName(this.dom.shadeAbove,"tfc-neutral","tfc-loss"),CIQ.swapClassName(this.dom.shadeBelow,"tfc-neutral","tfc-loss"),CIQ.appendClassName(this.dom.otoAbove,"bracket"),CIQ.appendClassName(this.dom.otoBelow,"bracket");var t=this.account.positions[this.stx.chart.symbol];e&&e.trade&&(t=e.trade),this.elements.otoAboveLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoAboveLegLabel,"above-leg"),CIQ.unappendClassName(this.elements.otoAboveLegLabel,"below-leg"),this.elements.otoBelowLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoBelowLegLabel,"above-leg"),CIQ.unappendClassName(this.elements.otoBelowLegLabel,"below-leg"),t.quantity>0?(this.activeTrade="bracket_sell",CIQ.swapClassName(this.dom.dragLineAbove,"red","green"),CIQ.swapClassName(this.dom.dragLineBelow,"red","green"),CIQ.appendClassName(this.dom.limitOrder,"new-sell-order"),CIQ.appendClassName(this.elements.otoAboveLegLabel,"above-leg"),CIQ.appendClassName(this.elements.otoBelowLegLabel,"below-leg")):(this.activeTrade="bracket_cover",CIQ.swapClassName(this.dom.dragLineAbove,"green","red"),CIQ.swapClassName(this.dom.dragLineBelow,"green","red"),CIQ.appendClassName(this.dom.limitOrder,"new-cover-order"),CIQ.appendClassName(this.elements.otoAboveLegLabel,"below-leg"),CIQ.appendClassName(this.elements.otoBelowLegLabel,"above-leg")),this.elements.sharesOwned.innerHTML=CIQ.commas(t.quantity),this.setActiveInput("shares"),CIQ.appendClassName(this.dom.limitOrder,"with-stop"),CIQ.appendClassName(this.dom.limitOrder,"with-limit"),this.centerPrice=this.getCurrentPriceForOrder();var i=this.stx.pixelFromPriceTransform(this.centerPrice,this.chart.panel),s=i-50,n=i+50;e&&e.trade&&e.trade.protect&&(e.trade.quantity>0&&e.trade.protect.limit?s=this.stx.pixelFromPriceTransform(e.trade.protect.limit,this.chart.panel):e.trade.quantity<0&&e.trade.protect.stop&&(s=this.stx.pixelFromPriceTransform(e.trade.protect.stop,this.chart.panel)),e.trade.quantity>0&&e.trade.protect.stop?n=this.stx.pixelFromPriceTransform(e.trade.protect.stop,this.chart.panel):e.trade.quantity<0&&e.trade.protect.limit&&(n=this.stx.pixelFromPriceTransform(e.trade.protect.limit,this.chart.panel))),this.positionAboveLine(this.stx.valueFromPixelUntransform(s,this.chart.panel)),this.positionBelowLine(this.stx.valueFromPixelUntransform(n,this.chart.panel)),this.updateValues(),this.render()},CIQ.TFC.prototype.enableStraddle=function(){this.activeTrade="straddle",CIQ.swapClassName(this.dom.dragLineAbove,"green","red"),CIQ.swapClassName(this.dom.dragLineBelow,"green","red"),CIQ.unappendClassName(this.dom.shadeAbove,"tfc-neutral"),CIQ.unappendClassName(this.dom.shadeBelow,"tfc-neutral"),CIQ.swapClassName(this.dom.shadeAbove,"tfc-profit","tfc-loss"),CIQ.swapClassName(this.dom.shadeBelow,"tfc-profit","tfc-loss"),this.elements.ocoAboveHead.innerHTML="Buy Stop",this.elements.ocoBelowHead.innerHTML="Sell Stop",this.centerPrice=this.getCurrentPriceForOrder();var e=this.stx.pixelFromPriceTransform(this.centerPrice,this.chart.panel);this.positionAboveLine(this.stx.valueFromPixelUntransform(e-50,this.chart.panel)),this.positionBelowLine(this.stx.valueFromPixelUntransform(e+50,this.chart.panel)),this.updateValues(),this.render()},CIQ.TFC.prototype.enableStrangle=function(){this.activeTrade="strangle",CIQ.swapClassName(this.dom.dragLineAbove,"red","green"),CIQ.swapClassName(this.dom.dragLineBelow,"red","green"),CIQ.unappendClassName(this.dom.shadeAbove,"tfc-neutral"),CIQ.unappendClassName(this.dom.shadeBelow,"tfc-neutral"),CIQ.swapClassName(this.dom.shadeAbove,"tfc-loss","tfc-profit"),CIQ.swapClassName(this.dom.shadeBelow,"tfc-loss","tfc-profit"),this.elements.ocoAboveHead.innerHTML="Sell Limit",this.elements.ocoBelowHead.innerHTML="Buy Limit",this.centerPrice=this.getCurrentPriceForOrder();var e=this.stx.pixelFromPriceTransform(this.centerPrice,this.chart.panel);this.positionAboveLine(this.stx.valueFromPixelUntransform(e-50,this.chart.panel)),this.positionBelowLine(this.stx.valueFromPixelUntransform(e+50,this.chart.panel)),this.updateValues(),this.render()},CIQ.TFC.prototype.addOTOStop=function(e){this.isMobileMode();CIQ.appendClassName(this.dom.limitOrder,"with-stop"),"buy"==this.activeTrade?(this.dom.otoBelow.style.display="",this.dom.dragLineBelow.style.display="",e||(e=this.priceFromLocation(CIQ.stripPX(this.dom.limitOrder.style.top)+this.dom.limitOrder.offsetHeight)),this.positionBelowLine(e),this.elements.otoBelowLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoBelowLegLabel,"above-leg"),CIQ.appendClassName(this.elements.otoBelowLegLabel,"below-leg")):"short"==this.activeTrade&&(this.dom.otoAbove.style.display="",this.dom.dragLineAbove.style.display="",e||(e=this.priceFromLocation(CIQ.stripPX(this.dom.limitOrder.style.top))),this.positionAboveLine(e),this.elements.otoAboveLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoAboveLegLabel,"above-leg"),CIQ.appendClassName(this.elements.otoAboveLegLabel,"below-leg")),this.updateValues()},CIQ.TFC.prototype.removeOTOAbove=function(){this.dom.otoAbove.style.display="none",this.dom.dragLineAbove.style.display="none","buy"==this.activeTrade?CIQ.unappendClassName(this.dom.limitOrder,"with-limit"):"short"==this.activeTrade?CIQ.unappendClassName(this.dom.limitOrder,"with-stop"):"bracket_sell"!=this.activeTrade&&"bracket_cover"!=this.activeTrade||"none"==this.dom.otoBelow.style.display&&this.closeTFC()},CIQ.TFC.prototype.addOTOLimit=function(e){this.isMobileMode();CIQ.appendClassName(this.dom.limitOrder,"with-limit"),"buy"==this.activeTrade?(this.dom.otoAbove.style.display="",this.elements.otoAboveLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoAboveLegLabel,"below-leg"),CIQ.appendClassName(this.elements.otoAboveLegLabel,"above-leg"),this.dom.dragLineAbove.style.display="",e||(e=this.priceFromLocation(CIQ.stripPX(this.dom.limitOrder.style.top))),this.positionAboveLine(e)):"short"==this.activeTrade&&(this.dom.otoBelow.style.display="",this.elements.otoBelowLegLabel.innerHTML="",CIQ.unappendClassName(this.elements.otoBelowLegLabel,"below-leg"),CIQ.appendClassName(this.elements.otoBelowLegLabel,"above-leg"),this.dom.dragLineBelow.style.display="",e||(e=this.priceFromLocation(CIQ.stripPX(this.dom.limitOrder.style.top)+this.dom.limitOrder.offsetHeight)),this.positionBelowLine(e)),this.updateValues()},CIQ.TFC.prototype.removeOTOBelow=function(){this.dom.otoBelow.style.display="none",this.dom.dragLineBelow.style.display="none","buy"==this.activeTrade?CIQ.unappendClassName(this.dom.limitOrder,"with-stop"):"short"==this.activeTrade?CIQ.unappendClassName(this.dom.limitOrder,"with-limit"):"bracket_sell"!=this.activeTrade&&"bracket_cover"!=this.activeTrade||"none"==this.dom.otoAbove.style.display&&this.closeTFC()},CIQ.TFC.prototype.setActiveInput=function(e){this.activeInput=e},CIQ.TFC.prototype.updateValues=function(){if(this.account){var e=this.isMobileMode(),t=this.getBidAsk(),i=t.Bid,s=t.Ask,n=this.centerPrice,r=this.account.positions[this.stx.chart.symbol];if("bracket_sell"==this.activeTrade||"bracket_cover"==this.activeTrade)if(this.elements.bracketId.value)for(var o=this.account.trades[this.stx.chart.symbol],a=0;a<o.length;a++)o[a].id==this.elements.bracketId.value&&(n=o[a].basis);else r&&(n=Math.abs(r.basis));var l=null,c=null,d=this.account.currency;this.stx.chart.symbol&&(this.account.currencyFromSymbol?d=this.account.currencyFromSymbol(this.stx.chart.symbol):this.account.isForex(this.stx.chart.symbol)&&(d=this.stx.chart.symbol.substr(this.stx.chart.symbol.length-3,3)));var h,m,u,p,C,f=null,y=null,b=this.stx.currentQuote();if("market"==this.activeTrade){if(!b)return;if("shares"==this.activeInput?(l=(c=this.quantityFromValue(this.elements.marketShares.value))*b.Close)>0&&CIQ.setValueIfNotActive(this.elements.marketCurrency,l.toFixed(0)):"currency"==this.activeInput&&(l=this.quantityFromValue(this.elements.marketCurrency.value),(c=Math.round(l/b.Close))>0&&CIQ.setValueIfNotActive(this.elements.marketShares,c)),f=Math.abs(this.quantityFromValue(this.elements.marketLossBracketDifferential.value)),y=Math.abs(this.quantityFromValue(this.elements.marketProfitBracketDifferential.value)),this.account.isForex(this.stx.chart.symbol)){var v=i.toString(),I=v.substring(0,v.indexOf("."));""===I&&(I="0");var g=v.substring(v.indexOf(".")+1),T=I+"."+g.substring(0,2),O=g.substring(2,4),Q=g.substring(4,5);this.elements.bidEquityPart.innerHTML=T,this.elements.bidForexPart.innerHTML=O+"<SUP>"+Q+"</SUP>",""===(I=(v=s.toString()).substring(0,v.indexOf(".")))&&(I="0"),T=I+"."+(g=v.substring(v.indexOf(".")+1)).substring(0,2),O=g.substring(2,4),Q=g.substring(4,5),this.elements.askEquityPart.innerHTML=T,this.elements.askForexPart.innerHTML=O+"<SUP>"+Q+"</SUP>"}else this.elements.askEquityPart.innerHTML=this.formatPrice(s),this.elements.bidEquityPart.innerHTML=this.formatPrice(i);l>0&&CIQ.setValueIfNotActive(this.elements.marketCurrency,CIQ.commas(l.toFixed(2))),c>0&&CIQ.setValueIfNotActive(this.elements.marketShares,CIQ.commas(c)),f&&CIQ.setValueIfNotActive(this.elements.marketLossBracketDifferential,f),y&&CIQ.setValueIfNotActive(this.elements.marketProfitBracketDifferential,y)}else this.limitFlippedToMarket&&(n=this.getCurrentPriceForOrder(this.activeTrade),this.positionCenterLine(n)),this.elements.dragLineCenterPrice.innerValue&&this.elements.dragLineCenterPrice.innerValue.length&&(n=this.quantityFromValue(this.elements.dragLineCenterPrice.innerValue)),"currency"==this.activeInput&&(this.elements.limitShares.disabled?this.activeInput="shares":(l=this.quantityFromValue(this.elements.limitCurrency.value),c=Math.round(l/n),CIQ.setValueIfNotActive(this.elements.limitShares,c))),"shares"==this.activeInput&&(l=(c=this.quantityFromValue(this.elements.limitShares.value))*n)>0&&CIQ.setValueIfNotActive(this.elements.limitCurrency,l.toFixed(0)),l&&CIQ.setValueIfNotActive(this.elements.limitCurrency,CIQ.commas(l.toFixed(2)));var $,w,x=this.quantityFromValue(this.elements.dragLineAbovePrice.innerValue),k=this.quantityFromValue(this.elements.dragLineBelowPrice.innerValue);"buy"!=this.activeTrade&&"bracket_sell"!=this.activeTrade||(u=m=(k-n)/n,h=(h=c*k-l)>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),c&&(this.elements.belowGainAmount.innerHTML=h),this.elements.belowGainPercent.innerHTML=m,p=m=(x-n)/n,h=(h=c*x-l)>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),c&&(this.elements.aboveGainAmount.innerHTML=h),this.elements.aboveGainPercent.innerHTML=m,u&&p&&(C=p/Math.abs(u),this.elements.limitRiskReward.innerHTML="1 : "+C.toFixed(1))),"short"!=this.activeTrade&&"bracket_cover"!=this.activeTrade||(m=u=(n-x)/n,u=m,h=(h=l-c*x)>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),c&&(this.elements.aboveGainAmount.innerHTML=h),this.elements.aboveGainPercent.innerHTML=m,p=m=(n-k)/n,h=(h=l-c*k)>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),c&&(this.elements.belowGainAmount.innerHTML=h),this.elements.belowGainPercent.innerHTML=m,u&&p&&(C=p/Math.abs(u),this.elements.limitRiskReward.innerHTML="1 : "+C.toFixed(1))),"sell"==this.activeTrade&&r&&((!c||c>r.quantity)&&(c=r.quantity),m=(h=(l=c*this.centerPrice)-($=r.basis*c))/$,h=h>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),this.elements.gainAmount.innerHTML=h,this.elements.gainPercent.innerHTML=m),"cover"==this.activeTrade&&r&&((!c||Math.abs(c)>Math.abs(r.quantity))&&(c=r.quantity),l=(c=Math.abs(c))*this.centerPrice,m=(h=($=Math.abs(r.basis)*c)-l)/$,h=h>0?"+"+CIQ.money(h,null,CIQ.convertCurrencyCode(d)):"-"+CIQ.money(Math.abs(h),null,CIQ.convertCurrencyCode(d)),(m=CIQ.commas((100*m).toFixed(2))+"%")>0&&(m="+"+m),this.elements.gainAmount.innerHTML=h,this.elements.gainPercent.innerHTML=m),"straddle"!=this.activeTrade&&"strangle"!=this.activeTrade||(l=this.quantityFromValue(this.elements.ocoCurrency.value),isNaN(l)&&(l=0),c=Math.round(l/x),this.elements.ocoAboveShares.innerHTML=CIQ.commas(c),c=Math.round(l/k),this.elements.ocoBelowShares.innerHTML=CIQ.commas(c));var L=this.account.tradesLikeForex(this.stx.chart.symbol);if(L){for(e&&this.elements.marketShares&&(this.elements.marketShares.placeholder="Units"),e&&this.elements.marketCurrency&&(this.elements.marketCurrency.placeholder="Amount"),w=0;w<this.elements.useDollarsLabel.length;w++)this.elements.useDollarsLabel[w].style.display="none",this.elements.useAmountLabel[w].style.display="";for(w=0;w<this.elements.useSharesLabel.length;w++)this.elements.useSharesLabel[w].style.display="none",this.elements.useUnitsLabel[w].style.display="";for(w=0;w<this.elements.usePipsLabel.length;w++)this.elements.usePointsLabel[w].style.display="none",this.elements.usePipsLabel[w].style.display=""}else{for(e&&this.elements.marketShares&&(this.elements.marketShares.placeholder="Shares"),e&&this.elements.marketCurrency&&(this.elements.marketCurrency.placeholder="Dollars"),w=0;w<this.elements.useAmountLabel.length;w++)this.elements.useAmountLabel[w].style.display="none",this.elements.useDollarsLabel[w].style.display="";for(w=0;w<this.elements.useUnitsLabel.length;w++)this.elements.useUnitsLabel[w].style.display="none",this.elements.useSharesLabel[w].style.display="";for(w=0;w<this.elements.usePointsLabel.length;w++)this.elements.usePipsLabel[w].style.display="none",this.elements.usePointsLabel[w].style.display=""}window.setMarketOrderPlaceholders&&window.setMarketOrderPlaceholders(this,L)}},CIQ.TFC.prototype.positionCenterLine=function(e,t){!1!==t&&(t=!0),this.centerPrice=e,this.positionAtPrice(this.centerPrice,["limitOrder","dragLineCenter"],"center",null,t),this.elements.dragLineCenterPrice.innerHTML=this.formatPrice(this.centerPrice),this.elements.dragLineCenterPrice.innerValue=this.formatInnerValue(this.centerPrice),this.positionBelowLine(Math.min(this.centerPrice,this.belowPrice)),this.positionAboveLine(Math.max(this.centerPrice,this.abovePrice))},CIQ.TFC.prototype.positionAboveLine=function(e,t){!1!==t&&(t=!0),isNaN(e)||(this.abovePrice=this.snapPrice(e),this.abovePrice<this.centerPrice&&(this.abovePrice=this.centerPrice),this.positionAtPrice(this.abovePrice,["dragLineAbove"],"center",null,t),this.elements.dragLineAbovePrice.innerHTML=this.formatPrice(this.abovePrice),this.elements.dragLineAbovePrice.innerValue=this.formatInnerValue(this.abovePrice),"short"==this.activeTrade||"buy"==this.activeTrade?this.positionAtPrice(this.abovePrice,["otoAbove"],"bottom",["limitOrder"],t):"strangle"==this.activeTrade||"straddle"==this.activeTrade?this.positionAtPrice(this.abovePrice,["ocoAbove"],"bottom",null,t):"bracket_sell"==this.activeTrade?this.positionAtPrice(this.abovePrice,["otoAbove"],"bottom",null,t):"bracket_cover"==this.activeTrade&&this.positionAtPrice(this.abovePrice,["otoAbove"],"bottom",null,t))},CIQ.TFC.prototype.positionBelowLine=function(e,t){!1!==t&&(t=!0),isNaN(e)||(this.belowPrice=this.snapPrice(e),this.belowPrice>this.centerPrice&&(this.belowPrice=this.centerPrice),this.positionAtPrice(this.belowPrice,["dragLineBelow"],"center",null,t),this.elements.dragLineBelowPrice.innerHTML=this.formatPrice(this.belowPrice),this.elements.dragLineBelowPrice.innerValue=this.formatInnerValue(this.belowPrice),"buy"==this.activeTrade||"short"==this.activeTrade?this.positionAtPrice(this.belowPrice,["otoBelow"],"top",["limitOrder"],t):"strangle"==this.activeTrade||"straddle"==this.activeTrade?(this.positionAtPrice(this.belowPrice,["ocoBelow"],"top",null,t),this.dom.ocoOrder.style.top=this.dom.ocoBelow.style.top):"bracket_sell"!=this.activeTrade&&"bracket_cover"!=this.activeTrade||(this.positionAtPrice(this.belowPrice,["otoBelow"],"top",null,t),this.dom.limitOrder.style.top=CIQ.stripPX(this.dom.otoBelow.style.top)+this.dom.otoBelow.clientHeight+"px"))},CIQ.TFC.prototype.render=function(){"sell"==this.activeTrade||"cover"==this.activeTrade?this.positionCenterLine(this.centerPrice):"buy"==this.activeTrade||"short"==this.activeTrade?(this.positionCenterLine(this.centerPrice),this.positionAboveLine(this.abovePrice),this.positionBelowLine(this.belowPrice)):"straddle"!=this.activeTrade&&"strangle"!=this.activeTrade||(this.positionAboveLine(this.abovePrice),this.positionBelowLine(this.belowPrice)),"bracket_sell"!=this.activeTrade&&"bracket_cover"!=this.activeTrade||(this.positionAboveLine(this.abovePrice),this.positionBelowLine(this.belowPrice),this.dom.shadeAbove.style.top="0px",this.dom.shadeAbove.style.bottom=this.chart.panel.height-this.locationFromPrice(this.abovePrice)+"px",this.dom.shadeBelow.style.top=this.locationFromPrice(this.belowPrice)+"px",this.dom.shadeBelow.style.bottom="0px"),"straddle"!=this.activeTrade&&"strangle"!=this.activeTrade||(this.dom.shadeAbove.style.top="0px",this.dom.shadeAbove.style.bottom=this.chart.panel.height-this.locationFromPrice(this.abovePrice)+"px",this.dom.shadeBelow.style.top=this.locationFromPrice(this.belowPrice)+"px",this.dom.shadeBelow.style.bottom="0px"),this.renderTrades(),this.renderOpenOrders()},CIQ.TFC.prototype.changeSymbol=function(){this.account&&("market"==this.activeTrade?this.enableMarket():this.activeTrade&&this.closeTFC(),this.configureMenu(),this.updateData(),this.populateMarket())},CIQ.TFC.prototype.priceFromLocation=function(e){var t=this.stx.valueFromPixelUntransform(e+this.chart.panel.top,this.chart.panel);return this.snapPrice(t)},CIQ.TFC.prototype.locationFromPrice=function(e){return this.stx.pixelFromPriceTransform(e,this.chart.panel)-this.chart.panel.top},CIQ.TFC.prototype.dragCenterLine=function(e){if(CIQ.hasClassName(this.dom.dragLineCenter,"dragging")&&"bracket_cover"!=this.activeTrade&&"bracket_sell"!=this.activeTrade){var t=this.initialPosition+e.displacementY+this.dom.dragLineCenter.offsetHeight/2,i=this.priceFromLocation(t);this.positionCenterLine(i),this.updateValues()}},CIQ.TFC.prototype.dragAboveLine=function(e){var t=this.initialPosition+e.displacementY+this.dom.dragLineAbove.offsetHeight/2,i=this.priceFromLocation(t);if("buy"==this.activeTrade||"short"==this.activeTrade||"bracket_sell"==this.activeTrade||"bracket_cover"==this.activeTrade)i<this.centerPrice&&(i=this.centerPrice);else if("strangle"==this.activeTrade||"straddle"==this.activeTrade){var s=this.stx.currentQuote().Close;i<s&&(i=s)}this.positionAboveLine(i),this.updateValues(),this.render()},CIQ.TFC.prototype.dragBelowLine=function(e){var t=this.initialPosition+e.displacementY+this.dom.dragLineBelow.offsetHeight/2,i=this.priceFromLocation(t);if("buy"==this.activeTrade||"short"==this.activetrade||"bracket_sell"==this.activeTrade||"bracket_cover"==this.activeTrade)i>this.centerPrice&&(i=this.centerPrice);else if("strangle"==this.activeTrade||"straddle"==this.activeTrade){var s=this.stx.currentQuote().Close;i>s&&(i=s)}this.positionBelowLine(i),this.updateValues(),this.render()},CIQ.TFC.prototype.hideAllDOM=function(){for(var e in this.dom){this.dom[e].style.display="none"}},CIQ.TFC.prototype.clearEphemeral=function(e){for(var t=this.ephemeralNodes[e],i=0;i<t.length;i++){var s=t[i];this.holder.removeChild(s)}this.ephemeralNodes[e]=[]},CIQ.TFC.prototype.instantiateTemplate=function(e,t){var i=this.templates[e].cloneNode(!0);return this.holder.appendChild(i),this.ephemeralNodes[t].push(i),i.style.display="",i},CIQ.TFC.prototype.createDescription=function(e){var t=e.action;return t+=" "+CIQ.commas(e.quantity),t+=" @ ",e.limit?t+=e.limit:e.stop?t+=e.stop:e.marketIfTouched?t+=e.marketIfTouched:t+="MKT",t.capitalize()},CIQ.TFC.prototype.modifyOpenOrder=function(e){this.ephemeralNodes.openOrders;var t=e.openOrder;if(this.modifyingOrder=t,this.renderOpenOrders(),this.setActiveInput("shares"),t.tif=t.product,CIQ.appendClassName(this.dom.limitOrder,"tfc-cancel"),"buy"==t.action||"cover"==t.action?CIQ.appendClassName(this.elements.limitReplace,"green"):CIQ.unappendClassName(this.elements.limitReplace,"green"),this.elements.cancelDescription.innerHTML=this.createDescription(t),"buy"==t.action?this.newTrade("enableBuy",{openOrder:t}):"cover"==t.action?this.newTrade("enableCover",{openOrder:t}):"sell"==t.action?this.newTrade("enableSell",{openOrder:t}):"short"==t.action&&this.newTrade("enableShort",{openOrder:t}),t.oto){"buy"==t.action?this.activeTrade="buy":this.activeTrade="short";for(var i=0;i<t.oto.length;i++){var s=t.oto[i];s.stop?this.addOTOStop(s.stop):s.limit&&this.addOTOLimit(s.limit)}}this.account.config.disableModifyOrderQuantity&&(this.elements.limitCurrency.readOnly=!0,this.elements.limitShares.readOnly=!0)},CIQ.TFC.prototype.overlap=function(e,t){var i=CIQ.stripPX(e.style.top),s=i+e.offsetHeight,n=CIQ.stripPX(t.style.top),r=n+t.offsetHeight;return i==n||(i<n&&s>n||i>n&&i<r)},CIQ.TFC.prototype.renderTrades=function(){if(this.account){var e=this.account.trades[this.stx.chart.symbol];if(e&&e.length>0)for(var t=0;t<e.length;t++){var i=e[t],s=this.stx.panels[this.chart.name];this.stx.startClip(s.name);var n=this.stx.tickFromDate(CIQ.yyyymmddhhmm(new Date(i.time))),r=this.stx.pixelFromTick(n),o=(this.stx.pixelFromTick(this.stx.chart.dataSet.length),this.stx.pixelFromValueAdjusted(s,n,i.basis)),a="stx-trade-position-line-down";if(i.price>i.basis&&i.quantity>0?a="stx-trade-position-line-up":i.price<i.basis&&i.quantity<0&&(a="stx-trade-position-line-up"),this.stx.canvasColor(a),a=this.stx.canvasStyle(a),this.chart.right>r&&(this.stx.plotLine(Math.max(this.chart.left,r),this.chart.right,o,o,a,"ray",this.chart.context,!0,{pattern:"dotted"}),this.chart.context.lineWidth=1,this.chart.context.beginPath(),this.chart.context.arc(r,o,3,0,2*Math.PI,!1),this.chart.context.fill(),this.chart.context.closePath(),o<this.chart.bottom&&o>this.chart.top)){this.stx.endClip();var l=Number(i.basis);s.chart.transformFunc&&(l=s.chart.transformFunc(this.stx,s.chart,l)),l=s.yAxis.priceFormatter?s.yAxis.priceFormatter(this.stx,s,l):this.stx.formatYAxisPrice(l,s),this.stx.createYAxisLabel(s,l,o,a.backgroundColor,a.color),this.chart.context.strokeStyle=a.color,this.chart.context.stroke(),this.stx.startClip(s.name)}this.stx.endClip()}}},CIQ.TFC.prototype.renderOpenOrders=function(){var e,t,i=this.ephemeralNodes.openOrders;for(e=0;e<i.length;e++){(t=i[e]).style.display="",t.style.width="";var s=t.openOrder,n=null;n=s.limit?s.limit:s.stop?s.stop:s.marketIfTouched?s.marketIfTouched:this.getCurrentPriceForOrder(s.action),this.positionAtPrice(n,[t],"center",null,!0);for(var r=0,o=e+1;o<i.length;o++){var a=i[o];this.overlap(t,a)&&(r+=30)}this.activeTrade&&"market"!=this.activeTrade&&(t.style.width="425px"),r&&(t.style.width=t.offsetWidth+r+"px")}for(e=0;e<i.length;e++)if(t=i[e],this.modifyingOrder&&this.modifyingOrder.id==t.openOrder.id&&(t.style.display="none",t.linked))for(var l=0;l<t.linked.length;l++)t.linked[l].style.display="none"},CIQ.TFC.prototype.createOpenOrderMarker=function(e,t){var i=this.instantiateTemplate("openOrderMarker","openOrders");i.openOrder=e;var s=$$$(".tfc-price",i);s.innerHTML=e.quantity,e.limit||e.stop||e.marketIfTouched||(s.innerHTML+=" MKT"),"sell"==e.action||"short"==e.action?CIQ.swapClassName(i,"red","green"):CIQ.swapClassName(i,"green","red"),t&&CIQ.appendClassName(i,"pending");var n,r=i;if(t&&(r=t,t.linked||(t.linked=[]),t.linked.push(i)),CIQ.safeClickTouch(s.parentNode,function(e,t){return function(){e.crosshairsOn(),e.modifyOpenOrder(t)}}(this,r)),i.addEventListener("mouseenter",(n=this,function(e){n.crosshairsOff()})),i.addEventListener("mouseleave",function(e){return function(t){e.crosshairsOn()}}(this)),e.oto)for(var o=0;o<e.oto.length;o++){var a=e.oto[o];this.createOpenOrderMarker(a,i)}},CIQ.TFC.prototype.deriveOpenOrderMarkers=function(){if(this.clearEphemeral("openOrders"),this.account.config.showOpenOrdersWhenTFCClosed||!CIQ.hasClassName($$$(".stx-trade-panel"),"closed")){var e=this.account.openOrders[this.stx.chart.symbol];if(e&&e.length>0){for(var t=0;t<e.length;t++){var i=e[t];i.cancelled||(i.multileg||this.createOpenOrderMarker(i))}this.renderOpenOrders()}}},CIQ.TFC.prototype.updateData=function(){var e=this,t={fetched:0};function i(e){return function(){e.tfc.selectSymbol&&e.tfc.selectSymbol(e.symbol),"position"==e.type&&!1!==e.tfc.account.config.reducePosition&&(e.tfc.setActiveInput("shares"),e.tfc.elements.marketShares.value=Math.abs(e.obj.quantity),e.tfc.updateValues())}}function s(t){return function(){e.clearActive();for(var i=0;i<e.menu.enableBracket.nodes.length;i++)CIQ.appendClassName(e.menu.enableBracket.nodes[i],"active");e.newTrade("enableBracket",{trade:t})}}function n(t){return function(i){e.confirmVspTrade(t)}}function r(t,i){return t.symbol=i,function(i){t.symbol&&e.confirmCloseTrade(t)}}function o(t,i){return t.symbol=i,function(i){i.stopPropagation(),t.symbol&&e.confirmClosePosition(t)}}function a(){e.deriveOpenOrderMarkers(),e.elements.currentCash.innerHTML=CIQ.money(e.account.balances.cash,0,CIQ.convertCurrencyCode(e.account.currency)),e.elements.currentFunds.innerHTML=CIQ.money(e.account.balances.buyingPower,0,CIQ.convertCurrencyCode(e.account.currency));var t=e.account.positions[e.stx.chart.symbol];t||(t={quantity:0,basis:0}),e.elements.currentPosition.innerHTML=CIQ.commas(t.quantity),$$$(".tfc-liquidity").innerHTML=CIQ.money(e.account.balances.liquidity,null,CIQ.convertCurrencyCode(e.account.currency)),$$$(".tfc-unsettled-cash").innerHTML=CIQ.money(e.account.balances.unsettledCash,null,CIQ.convertCurrencyCode(e.account.currency)),$$$(".tfc-cash").innerHTML=CIQ.money(e.account.balances.cash,null,CIQ.convertCurrencyCode(e.account.currency)),e.account.balances.profitLoss?($$$(".tfc-profitloss").parentNode.style.display="",$$$(".tfc-profitloss").innerHTML=CIQ.money(e.account.balances.profitLoss,null,CIQ.convertCurrencyCode(e.account.currency))):$$$(".tfc-profitloss").parentNode.style.display="none",$$$(".tfc-buying-power").innerHTML=CIQ.money(e.account.balances.buyingPower,null,CIQ.convertCurrencyCode(e.account.currency));var a=$$$(".stx-current-orders tbody");CIQ.clearNode(a);var l,c=!1,d=[];for(l in e.account.openOrders)d.push(l);var h,m,u,p,C,f,y=!1,b=!1,v=!1;for(u=0;u<d.length;u++){var I;l=d[u];var g=e.account.openOrders[l];if(g)for(m=0;m<g.length;m++){var T=g[m];if(c=!0,(y&&l!=e.stx.chart.symbol||!b&&l==e.stx.chart.symbol)&&(u&&((p=CIQ.newChild(a,"TR")).className="stx-divider",(C=CIQ.newChild(p,"TD")).setAttribute("colspan","7"),b=!0),y=!1),p=CIQ.newChild(a,"TR","tfc-symbol"),l==e.stx.chart.symbol&&(p.className="tfc-current-symbol tfc-symbol",y=!0),v&&(p.className=""),p.id="tfc-open-order-"+T.id,v?(T.action!=g[m-1].action?CIQ.newChild(p,"TD",null,T.action.capitalize()):C=CIQ.newChild(p,"TD"),C=CIQ.newChild(p,"TD"),f=(C=CIQ.newChild(p,"TD","open-order-bracket-ind","oco")).insertBefore(document.createElement("I"),C.firstChild),CIQ.appendClassName(f,"fa fa-flip-vertical"),f.appendChild(document.createTextNode(" "))):(CIQ.safeClickTouch(p,i({symbol:l,tfc:e,type:"order",obj:T})),CIQ.newChild(p,"TD",null,T.action.capitalize()),CIQ.newChild(p,"TD",null,T.quantity),CIQ.newChild(p,"TD",null,T.displaySymbol?T.displaySymbol:l)),I=0,T.limit?(!T.oco||v&&T.action!=g[m-1].action||!v&&T.id!=T.oco&&T.action!=g[m+1].action?CIQ.newChild(p,"TD",null,"@LMT"):CIQ.newChild(p,"TD",null,T.quantity<0?"@SL":"@TP"),CIQ.newChild(p,"TD",null,T.limit),I=T.limit):T.stop?(!T.oco||v&&T.action!=g[m-1].action||!v&&T.id!=T.oco&&T.action!=g[m+1].action?CIQ.newChild(p,"TD",null,"@STP"):CIQ.newChild(p,"TD",null,T.quantity<0?"@TP":"@SL"),CIQ.newChild(p,"TD",null,T.stop),I=T.stop):T.marketIfTouched?(CIQ.newChild(p,"TD",null,"@MIT"),CIQ.newChild(p,"TD",null,T.marketIfTouched),I=T.marketIfTouched):T.debit?(CIQ.newChild(p,"TD",null,T.debit>0?"@DB":"@CR"),CIQ.newChild(p,"TD",null,Math.abs(T.debit))):0===T.debit?(CIQ.newChild(p,"TD",null,"@EVEN"),CIQ.newChild(p,"TD",null,"")):(CIQ.newChild(p,"TD",null,"@MKT"),CIQ.newChild(p,"TD",null,"")),CIQ.newChild(p,"TD",null,v?"":T.tif),I?(h=T.contractSize?T.contractSize:1,CIQ.newChild(p,"TD",null,CIQ.money(I*T.quantity*h,null,CIQ.convertCurrencyCode(T.currency)))):CIQ.newChild(p,"TD",null,""),T.oto instanceof Array)for(var O=0;O<T.oto.length;O++)(p=CIQ.newChild(a,"TR")).id="tfc-open-order-"+T.id+"-oto-"+O,C=CIQ.newChild(p,"TD"),C=CIQ.newChild(p,"TD"),f=(C=CIQ.newChild(p,"TD","open-order-bracket-ind","oto")).insertBefore(document.createElement("I"),C.firstChild),CIQ.appendClassName(f,"fa fa-flip-vertical"),f.appendChild(document.createTextNode(" ")),I=0,T.oto[O].limit?(CIQ.newChild(p,"TD",null,T.quantity<0?"@SL":"@TP"),CIQ.newChild(p,"TD",null,T.oto[O].limit),I=T.oto[O].limit):T.oto[O].stop&&(CIQ.newChild(p,"TD",null,T.quantity<0?"@TP":"@SL"),CIQ.newChild(p,"TD",null,T.oto[O].stop),I=T.oto[O].stop),CIQ.newChild(p,"TD"),I?(h=T.contractSize?T.contractSize:1,CIQ.newChild(p,"TD",null,CIQ.money(I*T.quantity*h,null,CIQ.convertCurrencyCode(T.currency)))):CIQ.newChild(p,"TD",null,"");T.oco&&T.oco!=T.id&&(v=!v)}}c||CIQ.newChild(CIQ.newChild(a,"TR"),"TD","tfc-not-found").appendChild(CIQ.translatableTextNode(e.stx,"No Open Orders"));var Q,$=e.positionsView;for(l in a=$$$(".stx-current-position tbody"),CIQ.clearNode(a),c=!1,d=[],e.account.positions)d.push(l);for(y=!1,u=0;u<d.length;u++){var w={};if(l=d[u],t=e.account.positions[l]){c=!0;var x=CIQ.convertCurrencyCode(t.currency);if((y||l==e.stx.chart.symbol)&&(u&&((p=CIQ.newChild(a,"TR")).className="stx-divider",(C=CIQ.newChild(p,"TD")).setAttribute("colspan","5")),y=!1),(p=CIQ.newChild(a,"TR")).id="tfc-position-"+l,t.securityType&&"OPTION"==t.securityType.toUpperCase()||CIQ.safeClickTouch(p,i({symbol:l,tfc:e,type:"position",obj:t})),"lots"==$?(p.className="tfc-lots-position sym",(C=CIQ.newChild(p,"TD",null,l+(t.price?" @"+t.price:""))).setAttribute("colspan",5)):"maintenance"==$?(p.className="tfc-lots-position sym",(C=CIQ.newChild(p,"TD",null,l+(t.price?" @"+t.price:""))).setAttribute("colspan",5),(p=CIQ.newChild(a,"TR")).className="tfc-lots-position",CIQ.newChild(p,"TD","tfc-col-qty",t.quantity.toString()),CIQ.newChild(p,"TD",null,t.basis?t.basis:""),(C=CIQ.newChild(p,"TD","stx-btn click")).appendChild(CIQ.translatableTextNode(e.stx,"Close Position")),t.quantity>0?t.basis<t.price?CIQ.appendClassName(C,"up"):t.basis>t.price&&CIQ.appendClassName(C,"down"):t.basis>t.price?CIQ.appendClassName(C,"up"):t.basis<t.price&&CIQ.appendClassName(C,"down"),CIQ.safeClickTouch(C,o(t,l)),C.setAttribute("colspan",3)):(p.className="tfc-position",CIQ.newChild(p,"TD",null,l),h=t.contractSize?t.contractSize:1,"performance"==$?t.basis?(CIQ.newChild(p,"TD",null,CIQ.money(t.quantity*t.basis*h,0,x)),CIQ.newChild(p,"TD",null,CIQ.money(t.quantity*t.price*h,0,x))):(w.cost=CIQ.newChild(p,"TD",null,"N/A"),w.value=CIQ.newChild(p,"TD",null,"N/A")):(CIQ.newChild(p,"TD",null,t.quantity.toString()),CIQ.newChild(p,"TD",null,t.basis?t.basis:"N/A")),t.basis?(CIQ.newChild(p,"TD",null,CIQ.money((t.price-t.basis)*t.quantity*h,"performance"==$?0:null,x)),Q=(t.price-t.basis)/t.basis*100,t.quantity<0&&(Q*=-1),(Q=Q.toFixed(2))>0&&(Q="+"+Q),CIQ.newChild(p,"TD",null,Q+"%")):(w.gainloss=CIQ.newChild(p,"TD",null,"N/A"),w.pctGainloss=CIQ.newChild(p,"TD",null,"N/A"))),l==e.stx.chart.symbol&&(CIQ.appendClassName(p,"tfc-current-symbol"),y=!0),e.account.trades[l])for(var k=0,L=0,P=0;P<e.account.trades[l].length;P++){var A=e.account.trades[l][P];if(k+=A.basis*A.quantity*h,L+=A.price*A.quantity*h,("lots"==$||"maintenance"==$)&&((p=CIQ.newChild(a,"TR")).className="tfc-current-trades","lots"==$&&(C=CIQ.newChild(p,"TD","tfc-trade-date",CIQ.yyyymmdd(new Date(A.time)))),C=CIQ.newChild(p,"TD","tfc-col-qty stx-btn click",A.quantity),"maintenance"==$&&"M"==e.account.config.vsp&&l==e.stx.chart.symbol?CIQ.safeClickTouch(C,n(A)):(CIQ.unappendClassName(C,"stx-btn"),CIQ.unappendClassName(C,"click")),CIQ.newChild(p,"TD",null,A.basis),"lots"==$&&(h=A.contractSize?A.contractSize:1,CIQ.newChild(p,"TD",null,CIQ.money((A.price-A.basis)*A.quantity*h,null,CIQ.convertCurrencyCode(A.currency))),Q=(A.price-A.basis)/A.basis*100,A.quantity<0&&(Q*=-1),(Q=Q.toFixed(2)+"%")>0&&(Q="+"+Q),CIQ.newChild(p,"TD",null,Q)),"maintenance"==$)){C=CIQ.newChild(p,"TD","stx-btn click tfc-trade-actions");var F=!1;if(A.protect){if(A.protect.limit)CIQ.newChild(C,"SPAN",null," @TP "+e.printablePrice({limit:A.protect.limit})).style.color="green",F=!0;if(A.protect.stop)CIQ.newChild(C,"SPAN",null," @SL "+e.printablePrice({stop:A.protect.stop})).style.color="red",F=!0}F||(l==e.stx.chart.symbol?CIQ.newChild(C,"SPAN",null).appendChild(CIQ.translatableTextNode(e.stx,"Add Protection")):(C.className="tfc-trade-actions",CIQ.newChild(C,"SPAN",null).appendChild(CIQ.translatableTextNode(e.stx,"No Protection")))),C.setAttribute("colspan",2),l==e.stx.chart.symbol?CIQ.safeClickTouch(C,s(A)):(CIQ.unappendClassName(C,"stx-btn"),CIQ.unappendClassName(C,"click")),(C=CIQ.newChild(p,"TD","stx-btn click")).appendChild(CIQ.translatableTextNode(e.stx,"Close")),A.quantity>0?A.basis<A.price?CIQ.appendClassName(C,"up"):A.basis>A.price&&CIQ.appendClassName(C,"down"):A.basis>A.price?CIQ.appendClassName(C,"up"):A.basis<A.price&&CIQ.appendClassName(C,"down"),CIQ.safeClickTouch(C,r(A,l))}w.cost&&(w.cost.innerHTML=CIQ.money(k,null,CIQ.convertCurrencyCode(A.currency))),w.value&&(w.value.innerHTML=CIQ.money(L,null,CIQ.convertCurrencyCode(A.currency))),w.gainloss&&(w.gainloss.innerHTML=CIQ.money(L-k,"performance"==$?0:null,x)),w.pctGainloss&&(Q=(L-k)/k*100,t.quantity<0&&(Q*=-1),(Q=Q.toFixed(2))>0&&(Q="+"+Q),w.pctGainloss.innerHTML=Q+"%")}}}if(c)for(var N in e.account.config.closeAll&&(e.elements.closeAllPositions.style.display=""),$$$(".stx-trade-positions .tfc-positions-view.holder").style.display="",$$$(".stx-trade-positions thead").style.display="",$$$(".stx-trade-positions .tfc-positions-view.lots").style.display="none",e.account.trades){$$$(".stx-trade-positions .tfc-positions-view.lots").style.display="";break}else p=CIQ.newChild(a,"TR"),(C=CIQ.newChild(p,"TD","tfc-not-found")).appendChild(CIQ.translatableTextNode(e.stx,"No Positions")),e.elements.closeAllPositions.style.display="none",$$$(".stx-trade-positions .tfc-positions-view.holder").style.display="none",$$$(".stx-trade-positions thead").style.display="none";e.account.config.tradeActions?e.elements.positionsViewMaintenance.style.display="":e.elements.positionsViewMaintenance.style.display="none",e.refreshScrollWindows(),e.configureMenu()}function l(e){return function(){e.fetched++,e.fetched<4||a()}}a(),this.account.fetchBalances(l(t)),this.account.fetchTrades(l(t)),this.account.fetchPositions(l(t)),this.account.fetchOpenOrders(l(t))},CIQ.TFC.prototype.refreshScrollWindows=function(e){var t,i,s=$$$(".stx-section",$$$(".stx-panel-module.stx-trade-positions")),n=$$$(".stx-section",$$$(".stx-panel-module.stx-trade-current")),r=$$$(".stx-trade-ticket-toggle.close"),o=s.parentNode.parentNode.clientHeight-s.parentNode.offsetTop-r.clientHeight;"none"==$$$(".stx-trade-positions").style.display&&(o-=172);var a=0,l=0;if(this.account){var c,d;for(c in this.account.positions)a++;for(c in this.account.openOrders)for(var h=this.account.openOrders[c],m=0;m<h.length;m++)l++;if(e||(e=this.elements.openOrdersHeader.resizedTop),e)t=o-(i=Math.ceil(o+s.parentNode.offsetTop-e));else{var u=a/(a+l);(t=Math.ceil(o*u))<.5*o&&a>0?t=Math.round(.5*o):t>.5*o&&l>0&&(t=Math.round(.5*o)),i=o-t,"none"==$$$(".stx-trade-positions").style.display&&(i=o)}if(i<60&&(t=o-(i=60)),!a||t<60?(i=o-(t=60),CIQ.appendClassName(this.elements.openOrdersHeader,"no-resize")):CIQ.unappendClassName(this.elements.openOrdersHeader,"no-resize"),s.style.height=t-s.offsetTop+"px",n.style.height=i-n.offsetTop+"px",null===this.positionScroller){for(this.positionScroller=document.createElement("cq-scroll"),d=0;d<s.childNodes.length;d++)this.positionScroller.insertBefore(s.childNodes[0],this.positionScroller.childNodes[d]);s.appendChild(this.positionScroller)}else this.positionScroller.resize();if(null===this.openOrderScroller){for(this.openOrderScroller=document.createElement("cq-scroll"),d=0;d<n.childNodes.length;d++)this.openOrderScroller.insertBefore(n.childNodes[0],this.openOrderScroller.childNodes[d]);n.appendChild(this.openOrderScroller)}else this.openOrderScroller.resize()}},CIQ.TFC.prototype.configureMenu=function(){var e=this;if(!this.account)return t(e.menu.enableBuy.nodes,"none"),t(e.menu.enableSell.nodes,"none"),t(e.menu.enableShort.nodes,"none"),t(e.menu.enableCover.nodes,"none"),t(e.menu.enableStraddle.nodes,"none"),t(e.menu.enableStrangle.nodes,"none"),void t(e.menu.enableBracket.nodes,"none");function t(e,t){for(var i=0;i<e.length;i++)e[i].style.display=t}var i=e.stx.chart.symbol;this.account.tradability(i,(function(s){e.tradability=s,i||(s.tradable=!1);for(var n,r,o=e.account.positions[i],a=o&&o.quantity<0,l=o&&o.quantity>0,c=e.account.trades[i],d=0;c&&d<c.length;d++)c[d].quantity<0?a=!0:l=!0;if(!1===e.account.config.reducePosition)for(var h=e.account.openOrders[i],m=0;h&&m<h.length;m++)h[m].vspId||h[m].oto||("sell"==h[m].action.toLowerCase()||"short"==h[m].action.toLowerCase()?a=!0:"buy"!=h[m].action.toLowerCase()&&"cover"!=h[m].action.toLowerCase()||(l=!0));if(t(e.menu.enableBuy.nodes,"none"),t(e.menu.enableSell.nodes,"none"),t(e.menu.enableShort.nodes,"none"),t(e.menu.enableCover.nodes,"none"),t(e.menu.enableStraddle.nodes,"none"),t(e.menu.enableStrangle.nodes,"none"),t(e.menu.enableBracket.nodes,"none"),s.tradable&&s.marketable){if(t(e.menu.enableMarket.nodes,""),!e.modifyingOrder&&-1!=e.menu.enableMarket.nodes[0].className.indexOf("active"))for(n=0;n<e.menu.enableMarket.dom.length;n++)r=e.menu.enableMarket.dom[n],e.dom[r].style.display="";CIQ.unappendClassName(e.elements.marketBuy,"disabled"),CIQ.unappendClassName(e.elements.marketSell,"disabled"),e.account.config.hedging||!1!==e.account.config.reducePosition||(a&&CIQ.appendClassName(e.elements.marketBuy,"disabled"),l&&CIQ.appendClassName(e.elements.marketSell,"disabled"))}else{for(t(e.menu.enableMarket.nodes,"none"),n=0;n<e.menu.enableMarket.dom.length;n++)r=e.menu.enableMarket.dom[n],e.dom[r].style.display="none";if(!s.tradable)return}l||a?(e.account.config.hedging?(t(e.menu.enableBuy.nodes,""),t(e.menu.enableShort.nodes,""),!1!==e.account.config.reducePosition&&(a&&t(e.menu.enableCover.nodes,""),l&&t(e.menu.enableSell.nodes,""))):a&&!l?(t(e.menu.enableShort.nodes,""),!1!==e.account.config.reducePosition&&t(e.menu.enableCover.nodes,"")):!a&&l&&(t(e.menu.enableBuy.nodes,""),!1!==e.account.config.reducePosition&&t(e.menu.enableSell.nodes,"")),e.account.config.oco&&t(e.menu.enableBracket.nodes,"")):(t(e.menu.enableBuy.nodes,""),t(e.menu.enableShort.nodes,""),e.account.config.oco&&(t(e.menu.enableStraddle.nodes,""),t(e.menu.enableStrangle.nodes,""))),s.shortable||(t(e.menu.enableShort.nodes,"none"),t(e.menu.enableStraddle.nodes,"none"),t(e.menu.enableStrangle.nodes,"none"))}))},CIQ.TFC.prototype.openTFC=function(){this.crosshairsOriginallyOn=this.stx.layout.crosshair,this.positionsView||(this.positionsView="summary"),this.configureMenu(),this.updateData()},CIQ.TFC.prototype.closeTFC=function(){CIQ.hideKeyboard(),CIQ.fixScreen(),this.modifyingOrder=null,this.stx.layout.crosshair=this.crosshairsOriginallyOn,this.activeTrade=null,this.clearActive(),this.hideAllDOM(),CIQ.hasClassName($$$(".stx-trade-panel"),"closed")&&(this.account&&this.account.config.showOpenOrdersWhenTFCClosed||this.clearEphemeral("openOrders")),this.stx.resizeChart();var e=Math.round(this.stx.preferences.whitespace/this.stx.layout.candleWidth);this.stx.chart.scroll=this.stx.chart.maxTicks-e,this.stx.displayInitialized&&this.stx.draw(),this.updateData()},CIQ.TFC.prototype.newTrade=function(e,t){t&&t.openOrder||(this.modifyingOrder=null,CIQ.unappendClassName(this.dom.limitOrder,"tfc-cancel"),this.elements.limitCurrency.readOnly=!1,this.elements.limitShares.readOnly=!1),this.hideAllDOM();for(var i=this.menu[e].dom,s=0;s<i.length;s++){var n=i[s];this.dom[n].style.display=""}if(this.crosshairsOriginallyOn=this.stx.layout.crosshair,this.stx.layout.crosshair=!1,this[e](t),this.stx.resizeChart(),"enableMarket"!=e){var r=Math.round(this.width/this.stx.layout.candleWidth);this.stx.chart.scroll=this.stx.chart.maxTicks-r,this.stx.draw()}this.updateValues()},CIQ.TFC.prototype.clearActive=function(){for(var e in this.menu)for(var t=this.menu[e].nodes,i=0;i<t.length;i++)CIQ.unappendClassName(t[i],"active");this.elements.marketShares.value="",this.elements.marketCurrency.value="",this.elements.marketLossBracketDifferential.value="",this.elements.marketProfitBracketDifferential.value="",this.elements.limitShares.value="",this.elements.limitCurrency.value="",this.elements.ocoCurrency.value="",CIQ.unappendClassName(this.dom.otoAbove,"bracket"),CIQ.unappendClassName(this.dom.otoBelow,"bracket")},CIQ.TFC.prototype.placeOrder=function(e){let t=1;window.kiteAPI&&window.kiteAPI.instrumentManager&&(t=window.kiteAPI.instrumentManager.get(this.stx.chart.symbolObject.symbol.toUpperCase(),this.stx.chart.symbolObject.segment).lotSize);let i=0;if(i="object"==typeof e.quantity?e.quantity.new:e.quantity,i%t!=0||i<0){let e=document.getElementsByClassName("tfc-error")[0];return e.innerHTML="Qty. should be a multiple of "+t,void(e.style.display="block")}var s=this;function n(e){CIQ.TFC.dismissDialog(),e&&CIQ.alert(e),s.updateData(),s.stx.draw()}if("close"==e.type){var r=this.account.trades[e.symbol];if(r&&e.id){for(var o=0;o<r.length;o++)if(r[o].id==e.id){r[o].symbol=e.symbol,this.account.closeTrade(this,r[o],n);break}}else{var a=this.account.positions[e.symbol],l="No matching position found.";if(a){a.symbol=e.symbol;a.quantity;Math.abs(a.quantity)==Math.abs(e.quantity)&&(this.account.closePosition(this,a,n),l=null)}l&&n(l)}}else"replace"==e.type?this.account.replaceOrder(this,e,(function(t,i){if(CIQ.TFC.dismissDialog(),t&&CIQ.alert(t),i&&i.id){for(var n=s.stx.chart.symbol,r=s.account.openOrders[n],o=0;o<r.length;o++){var a=r[o];a.id==e.id&&(a.id=i.id,e.limit.new?a.limit=e.limit.new:delete a.limit,e.stop.new?a.stop=e.stop.new:delete a.stop,e.marketIfTouched.new?a.marketIfTouched=e.marketIfTouched.new:delete a.marketIfTouched,e.quantity.new&&(a.quantity=e.quantity.new))}s.deriveOpenOrderMarkers()}s.updateData(),s.closeTFC(),s.stx.draw()})):e instanceof Array&&e[0].tradeid?this.account.setProtection(this,e,(function(t,i){if(CIQ.TFC.dismissDialog(),t&&CIQ.alert(t),i&&i.id){for(var n=s.stx.chart.symbol,r=s.account.trades[n],o=0;o<r.length;o++){var a=r[o];if(a.id==e[0].tradeid){a.protect={};for(var l=0;l<e.length;l++)e[l].limit&&(a.protect.limit=e[l].limit),e[l].stop&&(a.protect.stop=e[l].stop)}}var c=s.account.openOrders[n];c||(c=s.account.openOrders[n]=[]);var d=0;for(o=0;o<c.length;o++){var h=c[o];if(h.tradeid==e[0].tradeid){if(1==e.length){if(d){c.splice(o,1);break}h.oco=null}h.id=i.id[d],e.length>1?h.oco=i.id[1-d]:h.oco=h.id,h.limit=h.stop=null,e[d].limit&&(h.limit=e[d].limit),e[d].stop&&(h.stop=e[d].stop),d++}}for(;d<e.length;d++)e[d].id=i.id[d],e.length>1?e[d].oco=i.id[1-d]:e[d].oco=e[d].id,c.push(e[d]);s.deriveOpenOrderMarkers()}s.updateData(),"market"!=s.activeTrade&&s.closeTFC(),s.stx.draw()})):this.account.placeOrder(this,e,(function(t,i){if(CIQ.TFC.dismissDialog(),t&&CIQ.alert(t),i&&i.id){e.id=i.id;var n=s.stx.chart.symbol,r=s.account.openOrders[n];r||(r=s.account.openOrders[n]=[]),r.push(e),s.deriveOpenOrderMarkers()}s.updateData(),"market"!=s.activeTrade&&s.closeTFC(),s.stx.draw()}))},CIQ.TFC.prototype.cancelOpenOrder=function(){var e=this.modifyingOrder,t=this;this.modalEnd(),t.account.cancelOrder(t,e,(function(e){!function(e,t,i){e.closeTFC()}(t)}))},CIQ.TFC.prototype.createOCOFromGUI=function(){var e={},t={};e.symbol=this.stx.chart.symbol,t.symbol=this.stx.chart.symbol,"strangle"==this.activeTrade?(e.quantity=this.quantityFromValue(this.elements.ocoAboveShares.innerHTML),t.quantity=this.quantityFromValue(this.elements.ocoBelowShares.innerHTML),e.action="sell",e.limit=this.quantityFromValue(this.elements.dragLineAbovePrice.innerValue),t.action="buy",t.limit=this.quantityFromValue(this.elements.dragLineBelowPrice.innerValue),e.tif=this.elements.ocoTIF.value,t.tif=this.elements.ocoTIF.value):"straddle"==this.activeTrade?(e.quantity=this.quantityFromValue(this.elements.ocoAboveShares.innerHTML),t.quantity=this.quantityFromValue(this.elements.ocoBelowShares.innerHTML),e.action="buy",e.stop=this.quantityFromValue(this.elements.dragLineAbovePrice.innerValue),t.action="sell",t.stop=this.quantityFromValue(this.elements.dragLineBelowPrice.innerValue),e.tif=this.elements.ocoTIF.value,t.tif=this.elements.ocoTIF.value):"bracket_cover"==this.activeTrade||"short"==this.activeTrade?(e.quantity=this.quantityFromValue(this.elements.limitShares.value),t.quantity=e.quantity,e.action="cover",e.stop=this.quantityFromValue(this.elements.dragLineAbovePrice.innerValue),t.action="cover",t.limit=this.quantityFromValue(this.elements.dragLineBelowPrice.innerValue),e.tif=this.elements.limitTIF.value,t.tif=this.elements.limitTIF.value,this.elements.bracketId.value&&(e.tradeid=this.elements.bracketId.value,t.tradeid=this.elements.bracketId.value)):"bracket_sell"!=this.activeTrade&&"buy"!=this.activeTrade||(e.quantity=this.quantityFromValue(this.elements.limitShares.value),t.quantity=e.quantity,e.action="sell",e.limit=this.quantityFromValue(this.elements.dragLineAbovePrice.innerValue),t.action="sell",t.stop=this.quantityFromValue(this.elements.dragLineBelowPrice.innerValue),e.tif=this.elements.limitTIF.value,t.tif=this.elements.limitTIF.value,this.elements.bracketId.value&&(e.tradeid=this.elements.bracketId.value,t.tradeid=this.elements.bracketId.value)),e.oco=!0,t.oco=!0;var i=[];return"straddle"!=this.activeTrade&&"strangle"!=this.activeTrade&&"none"==this.dom.otoAbove.style.display||i.push(e),"straddle"!=this.activeTrade&&"strangle"!=this.activeTrade&&"none"==this.dom.otoBelow.style.display||i.push(t),i},CIQ.TFC.prototype.quantityFromValue=function(e){if(!e)return 0;var t=parseFloat(e.replace(/,/g,""));return isNaN(t)&&(t=0),t},CIQ.TFC.prototype.createOrderFromGUI=function(e){var t={type:"order"};if(t.symbol=this.stx.chart.symbol,t.action={market_buy:"buy",market_sell:"sell",limit_buy:"buy",limit_sell:"sell",limit_short:"short",limit_cover:"cover",OCO:"OCO"}[e],"limit_buy"==e||"limit_sell"==e||"limit_short"==e||"limit_cover"==e){t.quantity=this.quantityFromValue(this.elements.limitShares.value),t.tif=this.elements.limitTIF.value;var i=this.getCurrentPriceForOrder(t.action),s=this.quantityFromValue(this.elements.dragLineCenterPrice.innerValue);this.limitFlippedToMarket||("buy"==t.action||"cover"==t.action?s<=i?t.limit=s:t.stop=s:s>=i?t.limit=s:t.stop=s)}else if("market_buy"==e||"market_sell"==e){if("market_buy"==e&&CIQ.hasClassName(this.elements.marketBuy,"disabled")||"market_sell"==e&&CIQ.hasClassName(this.elements.marketSell,"disabled"))return void(t.type="");var n=this.getBidAsk(),r=n.Bid,o=n.Ask;if(t.quantity=this.quantityFromValue(this.elements.marketShares.value),this.account.config.oto){t.oto=[];var a={};a.symbol=this.stx.chart.symbol,a.quantity=this.quantityFromValue(this.elements.marketShares.value),a.oco=!0,a.tif="GTC",a.action="market_buy"==e?"sell":"buy";var l=0;this.account.isForex(this.stx.chart.symbol)&&(!0,l=this.stx.chart.symbol.match(/(\^JPY.{3}|\^.{3}JPY)/)?2:4);var c=Number(this.elements.marketLossBracketDifferential.value)/Math.pow(10,l),d=Number(this.elements.marketProfitBracketDifferential.value)/Math.pow(10,l);c>0&&(t.oto.unshift(CIQ.shallowClone(a)),"sell"==a.action?t.oto[0].stop=r-c:t.oto[0].stop=o+c),d>0&&(t.oto.unshift(CIQ.shallowClone(a)),"sell"==a.action?t.oto[0].limit=r+d:t.oto[0].limit=o-d),0===t.oto.length&&(t.oto=null)}}if("none"!=this.dom.otoAbove.style.display||"none"!=this.dom.otoBelow.style.display){var h=this.createOCOFromGUI();h[0]&&(h[0].tif="GTC"),h[1]&&(h[1].tif="GTC"),t.oto=h}return t},CIQ.TFC.prototype.createReplaceFromGUI=function(){var e={type:"replace",symbol:"",action:"",limit:{},stop:{},marketIfTouched:{},quantity:{},tif:{},oto:{}};e.id=this.modifyingOrder.id,e.symbol=this.stx.chart.symbol,e.action=this.modifyingOrder.action,e.oco=this.modifyingOrder.oco,this.modifyingOrder.limit?e.limit.old=this.modifyingOrder.limit:this.modifyingOrder.stop?e.stop.old=this.modifyingOrder.stop:this.modifyingOrder.marketIfTouched&&(e.marketIfTouched.old=this.modifyingOrder.marketIfTouched);var t=this.getCurrentPriceForOrder(e.action),i=this.quantityFromValue(this.elements.dragLineCenterPrice.innerValue);if("buy"==e.action||"cover"==e.action?i<=t?e.limit.new=i:e.stop.new=i:i>=t?e.limit.new=i:e.stop.new=i,e.quantity.old=this.modifyingOrder.quantity,e.quantity.new=this.quantityFromValue(this.elements.limitShares.value),e.tif.old=this.modifyingOrder.tif,e.tif.new=this.elements.limitTIF.value,e.oto.old=this.modifyingOrder.oto,"none"!=this.dom.otoAbove.style.display||"none"!=this.dom.otoBelow.style.display){var s=this.createOCOFromGUI();s[0]&&(s[0].tif="GTC"),s[1]&&(s[1].tif="GTC"),e.oto.new=s}else e.oto.new=null;return e},CIQ.TFC.prototype.confirmReplace=function(e){this.modalEnd(),this.placeOrder(e)},CIQ.TFC.prototype.printableOTO=function(e){var t="";if(e)for(var i=0;i<e.length;i++){var s=e[i];1==i&&(t+=" / "),t+=s.action.capitalize()+" "+this.printablePrice(s)}return t},CIQ.TFC.prototype.confirmOrder=function(e){this.modalEnd(),this.placeOrder(e)},CIQ.TFC.prototype.confirmCloseTrade=function(e){var t=e.contractSize?e.contractSize:1,i={type:"close",id:e.id,action:"close",symbol:e.symbol?e.symbol:this.stx.chart.symbol,quantity:Math.abs(e.quantity),tif:"DAY",basis:CIQ.yyyymmdd(new Date(e.time))+" @"+e.basis,pl:CIQ.money((e.price-e.basis)*e.quantity*t,null,CIQ.convertCurrencyCode(e.currency))};this.config.skipConfirms?this.placeOrder(i):this.confirmOrder(i)},CIQ.TFC.prototype.confirmClosePosition=function(e){var t=e.contractSize?e.contractSize:1,i=0;if(this.account.trades){for(var s=0,n=0,r=0;r<this.account.trades[e.symbol].length;r++){var o=this.account.trades[e.symbol][r];s+=o.basis*o.quantity*t,n+=o.price*o.quantity*t}i=(n-s)*t}else i=(e.price-e.basis)*e.quantity*t;var a={type:"close",action:"close",symbol:e.symbol?e.symbol:this.stx.chart.symbol,quantity:Math.abs(e.quantity),tif:"DAY",pl:CIQ.money(i,null,CIQ.convertCurrencyCode(e.currency))};this.config.skipConfirms?this.placeOrder(a):this.confirmOrder(a)},CIQ.TFC.prototype.confirmVspTrade=function(e){e.contractSize&&e.contractSize;var t={type:"order",vspId:e.id,action:e.quantity>0?"sell":"cover",symbol:e.symbol?e.symbol:this.stx.chart.symbol,tif:"DAY",originalQuantity:Math.abs(e.quantity),basis:CIQ.yyyymmdd(new Date(e.time))+" @"+e.basis};this.confirmOrder(t)},CIQ.TFC.prototype.confirmCloseAllPositions=function(){var e=this;this.modalEnd(),CIQ.unappendClassName($$$("#tfcConfirmCloseAll"),"tfc-pending"),$$$("#tfcConfirmCloseAll .processOrder").style.display="block",$$$("#tfcConfirmCloseAll .orderProcessed").style.display="none",CIQ.TFC.displayDialog("#tfcConfirmCloseAll");var t=$$$("#tfcConfirmCloseAll .tfcSubmit"),i=$$$("#tfcConfirmCloseAll .tfcAbandon");CIQ.safeClickTouch(i,CIQ.TFC.dismissDialog),CIQ.safeClickTouch(t,(function(){CIQ.clearSafeClickTouches(t),CIQ.clearSafeClickTouches(i),$$$("#tfcConfirmCloseAll .processOrder").style.display="block",CIQ.appendClassName($$$("#tfcConfirmCloseAll"),"tfc-pending"),e.account.closeAllPositions(e,(function(t){CIQ.TFC.dismissDialog(),t&&CIQ.alert(t),e.updateData(),e.stx.draw()}))})),$$$("#tfcConfirmCloseAll .processOrder").style.display="none",$$$("#tfcConfirmCloseAll .orderProcessed").style.display="block"},CIQ.TFC.prototype.confirmOrPlaceOrder=function(e,t){var i;if("order"==e){if(0===(i=this.createOrderFromGUI(t)).quantity)return;this.config.skipConfirms?this.placeOrder(i):this.confirmOrder(i)}else if("OCO"==e||"bracket"==e){if(!(i=this.createOCOFromGUI())[0]||0===i[0].quantity)return;this.config.skipConfirms?this.placeOrder(i):this.confirmOCO(i,e)}else"replace"==e&&(i=this.createReplaceFromGUI(),this.config.skipConfirms?this.placeOrder(i):this.confirmReplace(i))},CIQ.TFC.prototype.formatPrice=function(e,t){e.toString();return this.tradability&&(this.tradability.maxDecimalPlaces||0===this.tradability.maxDecimalPlaces)?e.toFixed(this.tradability.maxDecimalPlaces):this.stx.chart.yAxis.priceFormatter&&!this.stx.chart.isComparison?this.stx.chart.yAxis.priceFormatter(this.stx,this.chart.panel,e):this.stx.formatYAxisPrice(e,this.chart.panel,null,null,t)},CIQ.TFC.prototype.formatInnerValue=function(e){var t;if(this.tradability&&(this.tradability.maxDecimalPlaces||0===this.tradability.maxDecimalPlaces))t=e.toFixed(this.tradability.maxDecimalPlaces);else{var i=this.stx.chart.yAxis,s=i.printDecimalPlaces;s||0===s||(s=this.stx.decimalPlacesFromPriceTick(i.priceTick)),t=e.toFixed(s)}return t},CIQ.TFC.prototype.printablePrice=function(e){return e.limit||e.stop||e.marketIfTouched?e.limit&&e.stop?this.formatPrice(e.limit)+" LMT "+this.formatPrice(e.stop)+" STP":e.limit?this.formatPrice(e.limit):e.stop?this.formatPrice(e.stop)+" STP":e.marketIfTouched?this.formatPrice(e.marketIfTouched)+" MIT":void 0:"MKT"},CIQ.TFC.prototype.confirmOCO=function(e,t){var i=[];i.push($$$("#tfcConfirmOCO .tfcOrderDescription1")),i.push($$$("#tfcConfirmOCO .tfcOrderDescription2"));for(var s=$$$("#tfcConfirmOCO .tfcOrderTif"),n=$$$("#tfcConfirmOCO h4"),r=document.querySelectorAll("#tfcConfirmOCO .stx-label"),o=0;o<2;o++)r[o].innerHTML="",i[o].innerHTML="";for(o=0;o<e.length;o++){var a=e[o],l=a.action+" "+CIQ.commas(a.quantity);this.account.tradesLikeForex(this.stx.chart.symbol)||(l+=" shares of"),l+=" "+a.symbol,l+=" @ ",l+=this.printablePrice(a),i[o].innerHTML=l.capitalize(),n.innerHTML="",r[o].innerHTML="","bracket"==t?(a.stop?r[o].appendChild(CIQ.translatableTextNode(this.stx,"Stop Loss")):a.limit&&r[o].appendChild(CIQ.translatableTextNode(this.stx,"Take Profit")),r[o].appendChild(document.createTextNode(":")),n.appendChild(CIQ.translatableTextNode(this.stx,"Confirm: Bracket / Protect"))):(r[o].appendChild(CIQ.translatableTextNode(this.stx,"Order")),r[o].appendChild(document.createTextNode(" "+(o+1)+":")),n.appendChild(CIQ.translatableTextNode(this.stx,"Confirm: One Cancels the Other")))}s.innerHTML="","DAY"==e[0].tif?s.appendChild(CIQ.translatableTextNode(this.stx,"Day Order")):"GTC"==e[0].tif&&s.appendChild(CIQ.translatableTextNode(this.stx,"Good Until Cancelled"));var c=$$$("#tfcConfirmOCO .tfcSubmit"),d=$$$("#tfcConfirmOCO .tfcAbandon");CIQ.safeClickTouch(c,function(e,t,i){return function(){CIQ.clearSafeClickTouches(i),CIQ.clearSafeClickTouches(d),$$$("#tfcConfirmOCO .processOrder").style.display="block",CIQ.appendClassName($$$("#tfcConfirmOCO"),"tfc-pending"),e.placeOrder(t)}}(this,e,c)),CIQ.safeClickTouch(d,CIQ.TFC.dismissDialog),this.modalEnd(),CIQ.TFC.displayDialog("#tfcConfirmOCO"),CIQ.unappendClassName($$$("#tfcConfirmOCO"),"tfc-pending"),$$$("#tfcConfirmOCO .processOrder").style.display="none",$$$("#tfcConfirmOCO .orderProcessed").style.display="block"},CIQ.TFC.prototype.userAction=function(e){"replace"==e?this.confirmOrPlaceOrder("replace"):"OCO"==e?this.confirmOrPlaceOrder("OCO",e):"bracket_cover"==this.activeTrade||"bracket_sell"==this.activeTrade?this.confirmOrPlaceOrder("bracket",e):this.confirmOrPlaceOrder("order",e)},CIQ.TFC.prototype.crosshairsOff=function(){this.crosshairMouseOverState=this.stx.layout.crosshair,this.stx.layout.crosshair=!1},CIQ.TFC.prototype.crosshairsOn=function(){this.stx.layout.crosshair=this.crosshairMouseOverState},CIQ.TFC.prototype.modalBegin=function(){this.stx.grabbingScreen||(this.stx.editingAnnotation=!0,this.stx.modalBegin())},CIQ.TFC.prototype.modalEnd=function(){this.stx.modalEnd(),this.stx.editingAnnotation=!1},CIQ.TFC.prototype.startDrag=function(e,t){t==this.dom.dragLineCenter&&this.limitFlippedToMarket||(this.initialPosition=CIQ.stripPX(t.style.top),this.stx.modalBegin(),CIQ.appendClassName(t,"dragging"))},CIQ.TFC.prototype.startDragOrdersHeader=function(e,t){this.initialPosition=t.parentNode.offsetTop,this.stx.modalBegin(),CIQ.appendClassName(t,"dragging")},CIQ.TFC.prototype.endDrag=function(e,t){this.stx.modalEnd(),CIQ.unappendClassName(t,"dragging")},CIQ.TFC.prototype.dragMarketOrder=function(e){var t=this.initialPosition+e.displacementY;t<0&&(t=0);var i=this.dom.marketOrder.parentNode;t+this.dom.marketOrder.offsetHeight>i.clientHeight&&(t=i.clientHeight-this.dom.marketOrder.offsetHeight),this.dom.marketOrder.style.top=t+"px"},CIQ.TFC.prototype.enableAccount=function(e){this.account=e,this.account.configureAccount&&this.account.configureAccount(),this.account.config||(this.account.config={}),this.account.config.oto?this.elements.addOTOStop.style.display="":this.elements.addOTOStop.style.display="none",this.account.config.tradeActions?this.elements.positionsViewMaintenance.style.display="":this.elements.positionsViewMaintenance.style.display="none",this.updateData()},CIQ.TFC.prototype.setResizeCallback=function(e){var t,i=this;CIQ.safeClickTouch($$$(".stx-trade-nav .stx-trade-ticket-toggle"),(t=this.stx,function(){t.preAdjustScroll(),CIQ.unappendClassName($$$(".stx-trade-nav"),"active"),CIQ.appendClassName($$$(".stx-trade-info"),"active"),i.refreshScrollWindows(),e(),t.postAdjustScroll()})),CIQ.safeClickTouch($$$(".stx-trade-info .stx-trade-ticket-toggle"),function(t){return function(){t.preAdjustScroll(),CIQ.unappendClassName($$$(".stx-trade-info"),"active"),CIQ.appendClassName($$$(".stx-trade-nav"),"active"),e(),t.postAdjustScroll()}}(this.stx))},CIQ.TFC.prototype.establishMenu=function(){function e(e,t){return function(i){if(e.stx.displayInitialized)if(-1==e.menu[t].nodes[0].className.indexOf("active")){e.clearActive();for(var s=0;s<e.menu[t].nodes.length;s++)CIQ.appendClassName(e.menu[t].nodes[s],"active");e.newTrade(t)}else e.closeTFC()}}for(var t in this.menu)for(var i=this.menu[t].nodes,s=0;s<i.length;s++)"enableBuy"===t?CIQ.safeClickTouch($(".stx-trade")[0],e(this,t)):CIQ.safeClickTouch(i[s],e(this,t))},CIQ.TFC.prototype.changePositionsView=function(e){for(var t=document.querySelectorAll(".tfc-positions-view"),i=0;i<t.length;i++)CIQ.hasClassName(t[i],e)?CIQ.appendClassName(t[i],"active"):CIQ.unappendClassName(t[i],"active");this.positionsView=e,this.updateData()},CIQ.TFC.prototype.construct=function(e){var t=$$$(".tfc.container");function i(e){return function(t){t.relatedTarget&&e.modalBegin()}}function s(e){return function(t){t.relatedTarget&&e.modalEnd()}}for(var n in this.config=e,this.chart=e.chart,this.stx=e.stx,this.width=t.offsetWidth,this.holder=this.stx.chart.panel.holder,this.dom.dragLineAbove=$$$(".drag-price-line",t).cloneNode(!0),this.dom.dragLineCenter=$$$(".drag-price-line",t).cloneNode(!0),this.dom.dragLineBelow=$$$(".drag-price-line",t).cloneNode(!0),this.dom.marketOrder=$$$(".market-order",t).cloneNode(!0),this.dom.limitOrder=$$$(".stx-limit-order",t).cloneNode(!0),this.dom.otoAbove=$$$(".OTO.stx-stop",t).cloneNode(!0),this.dom.otoBelow=$$$(".OTO.stx-stop",t).cloneNode(!0),this.dom.ocoOrder=$$$(".stx-oco-order",t).cloneNode(!0),this.dom.ocoAbove=$$$(".oco.tfc-oco-above",t).cloneNode(!0),this.dom.ocoBelow=$$$(".oco.tfc-oco-below",t).cloneNode(!0),this.dom.shadeAbove=$$$(".tfc-shade",t).cloneNode(!0),this.dom.shadeBelow=$$$(".tfc-shade",t).cloneNode(!0),this.dom){var r=this.dom[n];this.holder.appendChild(r),n in{shadeAbove:!0,shadeBelow:!0}||(r.addEventListener("mouseenter",i(this)),r.addEventListener("mouseleave",s(this)))}this.elements.marketBuy=$$$(".tfc-market-buy-action",this.dom.marketOrder),this.elements.marketSell=$$$(".tfc-market-sell-action",this.dom.marketOrder),this.elements.limitBuy=$$$(".click.tfc-buy",this.dom.limitOrder),this.elements.limitReplace=$$$(".click.tfc-replace",this.dom.limitOrder),this.elements.limitSell=$$$(".click.tfc-sell",this.dom.limitOrder),this.elements.limitShort=$$$(".click.tfc-short",this.dom.limitOrder),this.elements.limitCover=$$$(".click.tfc-cover",this.dom.limitOrder),this.elements.dragLineAbovePrice=$$$(".tfc-price",this.dom.dragLineAbove),this.elements.dragLineCenterPrice=$$$(".tfc-price",this.dom.dragLineCenter),this.elements.dragLineBelowPrice=$$$(".tfc-price",this.dom.dragLineBelow),this.elements.addOTOStop=$$$(".OTO.stop",this.dom.limitOrder),this.elements.removeOTOAbove=$$$(".stx-btn.stx-ico .stx-ico-close",this.dom.otoAbove),this.elements.addOTOLimit=$$$(".OTO.limit",this.dom.limitOrder),this.elements.removeOTOBelow=$$$(".stx-btn.stx-ico .stx-ico-close",this.dom.otoBelow),this.elements.sharesOwned=$$$(".tfc-shares-owned span",this.dom.limitOrder),this.elements.marketShares=$$$("input.tfc-shares",this.dom.marketOrder),this.elements.marketCurrency=$$$("input.tfc-currency",this.dom.marketOrder),this.elements.marketBracket=$$$(".tfc-market-section.complex",this.dom.marketOrder),this.elements.marketLossBracketDifferential=$$$(".tfc-market-section.complex input.tfc-market-loss-bracket",this.dom.marketOrder),this.elements.marketProfitBracketDifferential=$$$(".tfc-market-section.complex input.tfc-market-profit-bracket",this.dom.marketOrder),this.elements.limitShares=$$$("input.tfc-shares",this.dom.limitOrder),this.elements.limitCurrency=$$$("input.tfc-currency",this.dom.limitOrder),this.elements.gainAmount=$$$(".tfc-gain-amount",this.dom.limitOrder),this.elements.gainPercent=$$$(".tfc-gain-percent",this.dom.limitOrder),this.elements.aboveGainAmount=$$$(".tfc-gain-amount",this.dom.otoAbove),this.elements.aboveGainPercent=$$$(".tfc-gain-percent",this.dom.otoAbove),this.elements.belowGainAmount=$$$(".tfc-gain-amount",this.dom.otoBelow),this.elements.belowGainPercent=$$$(".tfc-gain-percent",this.dom.otoBelow),this.elements.ocoGainAmount=$$$(".tfc-gain-amount",this.dom.ocoOrder),this.elements.ocoGainPercent=$$$(".tfc-gain-percent",this.dom.ocoOrder),this.elements.otoAboveLegLabel=$$$(".tfc-oto-leg-label",this.dom.otoAbove),this.elements.otoBelowLegLabel=$$$(".tfc-oto-leg-label",this.dom.otoBelow),this.elements.limitRiskReward=$$$(".risk-reward .stx-data",this.dom.limitOrder),this.elements.ocoRiskReward=$$$(".inputTemplate .risk-reward",this.dom.ocoOrder),this.elements.askForexPart=$$$(".tfc-ask strong",this.dom.marketOrder),this.elements.bidForexPart=$$$(".tfc-bid strong",this.dom.marketOrder),this.elements.askEquityPart=$$$(".tfc-ask span",this.dom.marketOrder),this.elements.bidEquityPart=$$$(".tfc-bid span",this.dom.marketOrder),this.elements.ocoAboveHead=$$$(".stx-head",this.dom.ocoAbove),this.elements.ocoBelowHead=$$$(".stx-head",this.dom.ocoBelow),this.elements.ocoCurrency=$$$(".stx-data input",this.dom.ocoOrder),this.elements.ocoAboveShares=$$$(".stx-data span",this.dom.ocoAbove),this.elements.ocoBelowShares=$$$(".stx-data span",this.dom.ocoBelow),this.elements.ocoTrade=$$$(".click.oco",this.dom.ocoOrder),this.elements.limitTIF=$$$("select",this.dom.limitOrder),this.elements.ocoTIF=$$$("select",this.dom.ocoOrder),this.elements.limitDay=$$$("select .tfc-day",this.dom.limitOrder),this.elements.ocoDay=$$$("select .tfc-day",this.dom.ocoOrder),this.elements.mis=$$$("select .tfc-mis",this.dom.limitOrder),this.elements.cnc=$$$("select .tfc-cnc",this.dom.limitOrder),this.elements.nrml=$$$("select .tfc-nrml",this.dom.limitOrder),this.elements.bracketId=$$$(".tfc-bracketid",this.dom.ocoOrder),this.elements.abandonMarketOrder=$$$(".stx-btn.stx-ico",this.dom.marketOrder),this.elements.abandonLimitOrder=$$$(".stx-btn.stx-ico",this.dom.limitOrder),this.elements.abandonOCOOrder=$$$(".stx-btn.stx-ico",this.dom.ocoOrder),this.elements.cancelLimitOrder=$$$(".tfc-cancel-button",this.dom.limitOrder),this.elements.cancelDescription=$$$(".tfc-cancel-description",this.dom.limitOrder),this.elements.closeAllPositions=$$$(".stx-trade-panel .stx-btn.stx-close-all"),this.elements.positionsViewSummary=$$$(".stx-trade-panel .tfc-positions-view.summary"),this.elements.positionsViewLots=$$$(".stx-trade-panel .tfc-positions-view.lots"),this.elements.positionsViewPerformance=$$$(".stx-trade-panel .tfc-positions-view.performance"),this.elements.positionsViewMaintenance=$$$(".stx-trade-panel .tfc-positions-view.maintenance"),this.elements.useDollarsLabel=document.querySelectorAll(".stx-label.tfc-price-dollars"),this.elements.useAmountLabel=document.querySelectorAll(".stx-label.tfc-price-amt"),this.elements.useSharesLabel=document.querySelectorAll(".stx-label.tfc-shares-to-buy"),this.elements.useUnitsLabel=document.querySelectorAll(".stx-label.tfc-qty-to-buy"),this.elements.usePipsLabel=document.querySelectorAll(".stx-label.tfc-pips"),this.elements.usePointsLabel=document.querySelectorAll(".stx-label.tfc-points"),this.templates.openOrderMarker=$$$(".tfc .open-order-marker",t),this.menu.enableMarket.nodes=document.querySelectorAll(".stx-trade-panel .stx-market"),this.menu.enableBuy.nodes=document.querySelectorAll(".stx-trade-panel .stx-buy"),this.menu.enableSell.nodes=document.querySelectorAll(".stx-trade-panel .stx-sell"),this.menu.enableShort.nodes=document.querySelectorAll(".stx-trade-panel .stx-short"),this.menu.enableCover.nodes=document.querySelectorAll(".stx-trade-panel .stx-cover"),this.menu.enableStraddle.nodes=document.querySelectorAll(".stx-trade-panel .stx-straddle"),this.menu.enableStrangle.nodes=document.querySelectorAll(".stx-trade-panel .stx-strangle"),this.menu.enableBracket.nodes=document.querySelectorAll(".stx-trade-panel .stx-bracket"),this.establishMenu(),this.elements.currentCash=$$$(".stx-trade-panel .tfc-current-cash"),this.elements.currentFunds=$$$(".stx-trade-panel .tfc-current-funds"),this.elements.currentPosition=$$$(".stx-trade-panel .tfc-current-position"),this.elements.openOrdersHeader=$$$(".stx-trade-current .stx-head-bar");var o,a,l=CIQ.safeDrag(this.dom.marketOrder,(o=this,a=this.dom.marketOrder,function(e){o.startDrag(e,a)}),function(e){return function(t){e.dragMarketOrder(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.marketOrder)}}(this)),c={safety:l,absorbDownEvent:!1};CIQ.safeClickTouch(this.elements.marketBuy,function(e,t){return function(t){e.userAction("market_buy")}}(this),c),CIQ.safeClickTouch(this.elements.marketSell,function(e,t){return function(t){e.userAction("market_sell")}}(this),c),CIQ.safeClickTouch(this.elements.limitBuy,function(e,t){return function(t){e.userAction("limit_buy")}}(this),c),CIQ.safeClickTouch(this.elements.limitSell,function(e,t){return function(t){e.userAction("limit_sell")}}(this),c),CIQ.safeClickTouch(this.elements.limitShort,function(e,t){return function(t){e.userAction("limit_short")}}(this),c),CIQ.safeClickTouch(this.elements.limitCover,function(e,t){return function(t){e.userAction("limit_cover")}}(this),c),CIQ.safeClickTouch(this.elements.limitReplace,function(e,t){return function(t){e.userAction("replace")}}(this),c),CIQ.safeClickTouch(this.elements.ocoTrade,function(e,t){return function(t){e.userAction("OCO")}}(this),c),CIQ.safeDrag(this.dom.dragLineCenter,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineCenter),function(e){return function(t){e.dragCenterLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineCenter)}}(this)),l=CIQ.safeDrag(this.dom.limitOrder,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineCenter),function(e){return function(t){e.dragCenterLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineCenter)}}(this)),CIQ.safeDrag(this.dom.dragLineAbove,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineAbove),function(e){return function(t){e.dragAboveLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineAbove)}}(this)),CIQ.safeDrag(this.dom.ocoAbove,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineAbove),function(e){return function(t){e.dragAboveLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineAbove)}}(this)),CIQ.safeDrag(this.dom.otoAbove,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineAbove),function(e){return function(t){e.dragAboveLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineAbove)}}(this)),CIQ.safeDrag(this.dom.dragLineBelow,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineBelow),function(e){return function(t){e.dragBelowLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineBelow)}}(this)),CIQ.safeDrag(this.dom.ocoOrder),CIQ.safeDrag(this.dom.ocoBelow,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineBelow),function(e){return function(t){e.dragBelowLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineBelow)}}(this)),CIQ.safeDrag(this.dom.otoBelow,function(e,t){return function(i){e.startDrag(i,t)}}(this,this.dom.dragLineBelow),function(e){return function(t){e.dragBelowLine(t)}}(this),function(e){return function(t){e.endDrag(t,e.dom.dragLineBelow)}}(this)),c={safety:l},CIQ.safeClickTouch(this.elements.addOTOStop,function(e){return function(t){e.addOTOStop()}}(this),c),CIQ.safeClickTouch(this.elements.removeOTOAbove,function(e){return function(t){e.removeOTOAbove()}}(this)),CIQ.safeClickTouch(this.elements.addOTOLimit,function(e){return function(t){e.addOTOLimit()}}(this),c),CIQ.safeClickTouch(this.elements.removeOTOBelow,function(e){return function(t){e.removeOTOBelow()}}(this)),this.stx.append("draw",function(e){return function(){e.render()}}(this)),c={absorbDownEvent:!1},CIQ.safeClickTouch(this.elements.limitShares,function(e){return function(t){CIQ.isIOS7or8,t.target.focus(),e.setActiveInput("shares")}}(this),c),CIQ.safeClickTouch(this.elements.limitCurrency,function(e){return function(t){CIQ.isIOS7or8,t.target.focus(),e.setActiveInput("currency")}}(this),c),CIQ.safeClickTouch(this.elements.marketShares,function(e){return function(t){CIQ.isIOS7or8,t.target.focus(),e.setActiveInput("shares")}}(this),c),CIQ.safeClickTouch(this.elements.marketCurrency,function(e){return function(t){CIQ.isIOS7or8,t.target.focus(),e.setActiveInput("currency")}}(this),c),CIQ.safeClickTouch(this.elements.marketLossBracketDifferential,(function(e){CIQ.isIOS7or8&&(e.preventDefault(),e.target.focus())})),CIQ.safeClickTouch(this.elements.marketProfitBracketDifferential,(function(e){CIQ.isIOS7or8&&(e.preventDefault(),e.target.focus())})),this.elements.limitShares.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.limitCurrency.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.marketShares.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.marketCurrency.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.marketLossBracketDifferential.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.marketProfitBracketDifferential.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),this.elements.ocoCurrency.addEventListener("change",function(e){return function(t){e.updateValues()}}(this)),CIQ.safeClickTouch(this.elements.abandonLimitOrder,function(e){return function(t){e.closeTFC()}}(this)),CIQ.safeClickTouch(this.elements.abandonMarketOrder,function(e){return function(t){e.closeTFC()}}(this)),CIQ.safeClickTouch(this.elements.abandonOCOOrder,function(e){return function(t){e.closeTFC()}}(this)),CIQ.safeClickTouch(this.elements.cancelLimitOrder,function(e){return function(t){e.cancelOpenOrder()}}(this)),CIQ.safeClickTouch(this.elements.closeAllPositions,function(e){return function(t){e.confirmCloseAllPositions()}}(this)),CIQ.safeClickTouch(this.elements.positionsViewSummary,function(e){return function(t){e.changePositionsView("summary")}}(this)),CIQ.safeClickTouch(this.elements.positionsViewLots,function(e){return function(t){e.changePositionsView("lots")}}(this)),CIQ.safeClickTouch(this.elements.positionsViewPerformance,function(e){return function(t){e.changePositionsView("performance")}}(this)),CIQ.safeClickTouch(this.elements.positionsViewMaintenance,function(e){return function(t){e.changePositionsView("maintenance")}}(this)),e.showAbandonMarketOrder&&(this.elements.abandonMarketOrder.style.display=""),e.account&&this.enableAccount(e.account),CIQ.safeDrag(this.elements.openOrdersHeader,function(e,t){return function(i){e.startDragOrdersHeader(i,t)}}(this,this.elements.openOrdersHeader),function(e){return function(t){e.dragOrdersHeader(t)}}(this),function(e){return function(t){e.endDrag(t,e.elements.openOrdersHeader)}}(this)),window.addEventListener("resize",function(e){return function(){e.refreshScrollWindows()}}(this))};