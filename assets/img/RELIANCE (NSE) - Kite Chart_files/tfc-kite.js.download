var CIQ;function formatOrders(t){for(var e={},i=t,o=0;o<i.length;o++){let t={};t=i[o],e.hasOwnProperty(t.tradingsymbol)||(e[t.tradingsymbol]=[]),t.action=t.transaction_type.toLowerCase(),t.id=o+1,"LIMIT"===t.order_type?t.limit=t.price:"SL"!==t.order_type&&"SL-M"!==t.order_type||(t.stop=t.trigger_price),t.tif=t.validity,t.currency="INR",e[t.tradingsymbol].push(t)}return e}CIQ.Account.Kite=function(){this.currency="&#8377;",this.config={oto:!1,oco:!1,closeAll:!0,tradeActions:!0,vsp:"M",showOpenOrdersWhenTFCClosed:!0,skipConfirms:!0},this.positions={},this.trades={},this.openOrders={}},CIQ.Account.Kite.ciqInheritsFrom(CIQ.Account),CIQ.TFC.prototype.enableMarket=function(){if(window.kiteAPI&&window.kiteAPI.openOrderWindow){let t={action:"BUY"};window.kiteAPI.openOrderWindow(t,!0)}this.activeTrade="market",this.account&&(this.dom.marketOrder.style.top="0px",this.account.isForex(this.stx.chart.symbol)?(this.elements.askForexPart.style.visibility="",this.elements.bidForexPart.style.visibility=""):(this.elements.askForexPart.style.visibility="hidden",this.elements.bidForexPart.style.visibility="hidden"),this.account.config.oto?this.elements.marketBracket.style.display="":this.elements.marketBracket.style.display="none",this.updateValues(),this.populateMarket())},CIQ.Account.Kite.prototype.fetchBalances=function(t){t()},CIQ.Account.Kite.prototype.fetchPositions=function(t){for(var e=window.kiteAPI&&window.kiteAPI.positions?window.kiteAPI.positions.net:[],i=0;i<e.length;i++)this.positions[e[i].tradingsymbol]=e[i],this.positions[e[i].tradingsymbol].basis=e[i].average_price,this.positions[e[i].tradingsymbol].prevClose=e[i].last_price,this.positions[e[i].tradingsymbol].currency="INR";t()},CIQ.Account.Kite.prototype.fetchOpenOrders=function(t){this.openOrders=[];let e=[];if(window.kiteAPI&&stxx&&stxx.chart.symbolObject.symbol&&window.kiteAPI.pendingOrders.hasOwnProperty(stxx.chart.symbolObject.symbol.toUpperCase())){let t=window.kiteAPI.instrumentManager.get(stxx.chart.symbolObject.symbol,stxx.chart.symbolObject.segment).exchange;for(let i=0;i<window.kiteAPI.pendingOrders[stxx.chart.symbolObject.symbol.toUpperCase()].length;i++)window.kiteAPI.pendingOrders[stxx.chart.symbolObject.symbol.toUpperCase()][i].exchange===t&&e.push(window.kiteAPI.pendingOrders[stxx.chart.symbolObject.symbol.toUpperCase()][i]);this.openOrders[stxx.chart.symbolObject.symbol.toUpperCase()]=e}t()},CIQ.Account.Kite.prototype.fetchTrades=function(t){t()},CIQ.Account.Kite.prototype.placeOrder=function(t,e,i){e&&("SHORT"===e.action.toUpperCase()&&(e.action="SELL"),window.kiteAPI&&window.kiteAPI.openOrderWindow&&window.kiteAPI.openOrderWindow(e)),i()},CIQ.Account.Kite.prototype.cancelOrder=function(t,e,i){window.kiteAPI&&window.kiteAPI.openCancelOrderWindow&&window.kiteAPI.openCancelOrderWindow(e),i()},CIQ.Account.Kite.prototype.replaceOrder=function(t,e,i){let o=window.kiteAPI.pendingOrders[e.symbol];if(e&&window.kiteAPI.pendingOrders&&o&&("SHORT"===e.action.toUpperCase()&&(e.action="SELL"),window.kiteAPI&&window.kiteAPI.openOrderWindow)){e.limit=e.limit.new,e.stop=e.stop.new,e.quantity=e.quantity.new,e.tif=e.tif.new;for(let t=0;t<o.length;t++)if(e.id===o[t].id){for(let i in o[t])"limit"!==i&&"quantity"!==i&&"stop"!==i&&"tif"!==i&&(e[i]=o[t][i]);break}window.kiteAPI.openModifyOrderWindow(e)}i()},CIQ.Account.Kite.prototype.execute=function(t,e){var i=t.quantity;"sell"!=t.action&&"short"!=t.action||(i*=-1),this.balances.cash-=i*e,this.balances.buyingPower=2*this.balances.cash;var o=this.positions[t.symbol];o?(o.quantity<0&&("buy"==t.action?t.action="cover":"sell"==t.action&&(t.action="short")),"buy"!=t.action&&"short"!=t.action||(o.basis=((o.quantity*o.basis+i*e)/(o.quantity+i)).toFixed(2)),o.quantity+=Number(i),o.price=e,0===o.quantity&&delete this.positions[t.symbol]):this.positions[t.symbol]={quantity:i,basis:e,price:e,prevClose:e};var s={id:CIQ.uniqueID(),time:(new Date).getTime(),basis:e,price:e};if(t.oto&&(s.protect={},t.oto[0]&&t.oto[0].stop?s.protect.stop=t.oto[0].stop:t.oto[1]&&t.oto[1].stop&&(s.protect.stop=t.oto[1].stop),t.oto[0]&&t.oto[0].limit?s.protect.limit=t.oto[0].limit:t.oto[1]&&t.oto[1].limit&&(s.protect.limit=t.oto[1].limit)),this.trades[t.symbol]||(this.trades[t.symbol]=[]),"buy"==t.action||"short"==t.action)s.quantity=i,this.trades[t.symbol].push(s);else{for(var n=this.trades[t.symbol],r=-1*i,a=0;a<n.length;a++)if(!t.vspId||n[a].id==t.vspId){if(!(Math.abs(n[a].quantity)<=Math.abs(r))){if(n[a].quantity-=r,n[a].protect)for(var l=0;l<this.openOrders[t.symbol].length;l++){var d=this.openOrders[t.symbol][l];d.tradeid==n[a].id&&(d.quantity-=r)}r=0;break}if(r-=n[a].quantity,n[a].protect)for(var c=0;c<this.openOrders[t.symbol].length;c++){this.openOrders[t.symbol][c].tradeid==n[a].id&&this.openOrders[t.symbol].splice(c--,1)}n.splice(a--,1)}0===r?this.trades[t.symbol].length||delete this.trades[t.symbol]:(s.quantity=-1*r,this.trades[t.symbol].push(s))}for(var p=this.openOrders[t.symbol],y=0;y<p.length;y++)if(p[y].id==t.id){p.splice(y,1);break}if(s.quantity&&s.protect){var h=CIQ.uniqueID();s.protect.limit&&this.openOrders[t.symbol].push({id:h+"A",tradeid:s.id,action:"buy"==t.action?"sell":"cover",quantity:Math.abs(s.quantity),limit:s.protect.limit,tif:"GTC",oco:s.protect.stop?h+"B":null}),s.protect.stop&&this.openOrders[t.symbol].push({id:h+"B",tradeid:s.id,action:"buy"==t.action?"sell":"cover",quantity:Math.abs(s.quantity),stop:s.protect.stop,tif:"GTC",oco:s.protect.limit?h+"A":null})}this.openOrders[t.symbol].length||delete this.openOrders[t.symbol]},CIQ.Account.Kite.prototype.setProtection=function(t,e,i){for(var o=[],s=0;s<e.length;s++)o.push(e[s].tradeid+(e[s].limit?"|L":"|S"));i(null,{id:o})},CIQ.Account.Kite.prototype.closeAllPositions=function(t,e){for(var i in this.positions={},this.trades={},this.openOrders)for(var o=this.openOrders[i],s=0;s<o.length;s++)o[s].tradeid&&o.splice(s--,1);e()},CIQ.Account.Kite.prototype.closePosition=function(t,e,i){for(var o=this.trades[e.symbol],s=0;s<o.length;s++){var n=this.openOrders[e.symbol];if(n)for(var r=0;r<n.length;r++)n[r].tradeid==o[s].id&&n.splice(r--,1)}delete this.trades[e.symbol],delete this.positions[e.symbol],i()},CIQ.Account.Kite.prototype.closeTrade=function(t,e,i){for(var o=this.trades[e.symbol],s=0;s<o.length;s++)if(o[s].id==e.id){o.splice(s--,1);break}var n=this.positions[e.symbol];n.quantity==e.quantity?delete this.positions[e.symbol]:(n.basis=((n.quantity*n.basis-e.quantity*e.basis)/(n.quantity-e.quantity)).toFixed(2),n.quantity-=e.quantity);var r=this.openOrders[e.symbol];if(r)for(s=0;s<r.length;s++)r[s].tradeid==e.id&&r.splice(s--,1);i()},CIQ.Account.Kite.prototype.tifHasChanged=function(){this.limitFlippedToMarket="MKT"==this.elements.limitTIF.options[this.elements.limitTIF.selectedIndex].text;var t=document.getElementsByClassName("inputTemplate amount");t&&("MIS"===this.elements.limitTIF.options[this.elements.limitTIF.selectedIndex].text?t[0].style.display="none":t[0].style.display="block")},window.kiteAPI&&(window.kiteAPI.updateChart=function(){stxx&&stxx.tfc&&(stxx.tfc.account.openOrders=window.kiteAPI.pendingOrders,stxx.tfc.updateData())});